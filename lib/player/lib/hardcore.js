/*
 * Copyright (c) 2011-2013 by Animatron.
 * All rights are reserved.
 * 
 * Animatron player is licensed under the MIT License.
 * 
 * v0.9.12, built at Mon May 27 2013 20:20:19 GMT+0200 (CEST) (2013-05-27T18:20:19.383Z / 1369678819383)
 */
function Transform(){this.m=[1,0,0,1,0,0]}Transform.prototype.reset=function(){this.m=[1,0,0,1,0,0]};Transform.prototype.multiply=function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy};Transform.prototype.invert=function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5};Transform.prototype.rotate=function(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22};Transform.prototype.rotateDegrees=function(angle){var rad=angle*Math.PI/180;var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22};Transform.prototype.translate=function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y};Transform.prototype.scale=function(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy};Transform.prototype.transformPoint=function(px,py){return[px*this.m[0]+py*this.m[2]+this.m[4],px*this.m[1]+py*this.m[3]+this.m[5]]};Transform.prototype.apply=function(ctx){var m=this.m;ctx.transform(m[0],m[1],m[2],m[3],m[4],m[5])};Transform.prototype.clone=function(){var cl=new Transform;cl.m[0]=this.m[0];cl.m[1]=this.m[1];cl.m[2]=this.m[2];cl.m[3]=this.m[3];cl.m[4]=this.m[4];cl.m[5]=this.m[5];return cl};Transform.prototype.inverted=function(){var clone=this.clone();clone.invert();return clone};var anm=function(_window){var __frameFunc=function(){return _window.requestAnimationFrame||_window.webkitRequestAnimationFrame||_window.mozRequestAnimationFrame||_window.oRequestAnimationFrame||_window.msRequestAnimationFrame||_window.__anm__frameGen||function(callback){return _window.setTimeout(callback,1e3/60)}};var __clearFrameFunc=function(){return _window.cancelAnimationFrame||_window.webkitCancelAnimationFrame||_window.mozCancelAnimationFrame||_window.oCancelAnimationFrame||_window.msCancelAnimationFrame||_window.__anm__frameRem||function(id){return _window.clearTimeout(id)}};var __nextFrame;var __stopAnim=function(requestId){__clearFrameFunc()(requestId)};var SystemError=__errorAs("SystemError");var SysErr=SystemError;var PlayerError=__errorAs("PlayerError");var PlayerErr=PlayerError;var AnimationError=__errorAs("AnimationError");var AnimErr=AnimationError;function __collect_to(str,start,ch){var result="";for(var i=start;str[i]!==ch;i++){if(i===str.length)throw new SysErr("Reached end of string");result+=str[i]}return result}function guid(){return Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10)}function get_rgb(hex){if(!hex||!hex.length)return[0,0,0];var _hex=hex.substring(1);if(_hex.length===3){_hex=_hex[0]+_hex[0]+_hex[1]+_hex[1]+_hex[2]+_hex[2]}var bigint=parseInt(_hex,16);return[bigint>>16&255,bigint>>8&255,bigint&255]}function to_rgba(r,g,b,a){return"rgba("+Math.floor(r)+","+Math.floor(g)+","+Math.floor(b)+","+(typeof a!=="undefined"?a:1)+")"}function StopIteration(){}function iter(a){if(a.__iter){a.__iter.reset();return a.__iter}var pos=0,len=a.length;return a.__iter={next:function(){if(pos<len)return a[pos++];pos=0;throw new StopIteration},hasNext:function(){return pos<len},remove:function(){len--;return a.splice(--pos,1)},reset:function(){pos=0;len=a.length},get:function(){return a[pos]},each:function(f,rf){this.reset();while(this.hasNext()){if(f(this.next())===false){if(rf)rf(this.remove());else this.remove()}}}}}function obj_clone(what){var dest={};for(var prop in what){dest[prop]=what[prop]}return dest}function find_pos(elm){var curleft=0,curtop=0;do{curleft+=elm.offsetLeft;curtop+=elm.offsetTop}while(elm=elm.offsetParent);return[curleft,curtop]}function ajax(url,callback){var req=false;if(!_window.ActiveXObject){req=new XMLHttpRequest}else{try{req=new ActiveXObject("Msxml2.XMLHTTP")}catch(e1){try{req=new ActiveXObject("Microsoft.XMLHTTP")}catch(e2){throw new SysErr("No AJAX/XMLHttp support")}}}if(!req){throw new SysErr("Failed to create XMLHttp instance")}var whenDone=function(){if(req.readyState==4){if(req.status==200){if(callback)callback(req)}else{throw new SysErr("AJAX request for "+url+" returned "+req.status+" instead of 200")}}};req.onreadystatechange=whenDone;req.open("GET",url,true);req.send(null)}function getPxRatio(){return _window.devicePixelRatio||1}var DEF_CNVS_WIDTH=400;var DEF_CNVS_HEIGHT=250;var DEF_CNVS_BG="#fff";function canvasOpts(canvas,opts,ratio){var isObj=!(opts instanceof Array),_w=isObj?opts.width:opts[0],_h=isObj?opts.height:opts[1];if(isObj&&opts.bgcolor&&opts.bgcolor.color){canvas.style.backgroundColor=opts.bgcolor.color}canvas.__pxRatio=ratio;canvas.style.width=_w+"px";canvas.style.height=_h+"px";canvas.setAttribute("width",_w*(ratio||1));canvas.setAttribute("height",_h*(ratio||1))}function newCanvas(dimen,ratio){var _canvas=document.createElement("canvas");canvasOpts(_canvas,dimen,ratio);return _canvas}var __finite=isFinite||Number.isFinite||function(n){return n!==Infinity};var __nan=isNaN||Number.isNaN||function(n){n!==NaN};function __builder(obj){return typeof Builder!=="undefined"&&obj instanceof Builder}var __arr=Array.isArray;function __num(n){return!__nan(parseFloat(n))&&__finite(n)}function __fun(fun){return fun!=null&&typeof fun==="function"}function __obj(obj){return obj!=null&&typeof obj==="object"}function __str(obj){return obj!=null&&typeof obj==="string"}function __close(n1,n2,precision){if(!(precision===0)){precision=precision||2}var multiplier=Math.pow(10,precision);return Math.round(n1*multiplier)==Math.round(n2*multiplier)}function __roundTo(n,precision){if(!precision)return Math.round(n);var multiplier=Math.pow(10,precision);return Math.round(n*multiplier)/multiplier}function __errorAs(name,_constructor,_toStr){var _producer=_constructor?function(message){_constructor.apply(this,arguments);if(!this.message)this.message=message||"";Error.apply(this,arguments)}:function(message){this.message=message||"";Error.apply(this,arguments)};_producer.prototype=new Error;_producer.prototype.constructor=_producer;_producer.prototype.name=name||"Unknown";_producer.prototype.toString=_toStr||function(){return this.name+(this.message?": "+this.message:"")};return _producer}function __paramsToObj(pstr){var o={},ps=pstr.split("&"),i=ps.length,pair;while(i--){pair=ps[i].split("=");o[pair[0]]=pair[1]}return o}function _mrg_obj(src,backup){if(!backup)return src;var res={};for(prop in backup){res[prop]=typeof src[prop]!=="undefined"?src[prop]:backup[prop]}return res}function _strf(str,subst){var args=subst;return str.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!="undefined"?args[number]:match})}var trashBin=null;function disposeElm(domElm){if(!trashBin){trashBin=document.createElement("div");trashBin.id="trash-bin";trashBin.style.display="none";document.body.appendChild(trashBin)}trashBin.appendChild(domElm);trashBin.innerHTML=""}var TIME_PRECISION=9;function __adjust(t){return __roundTo(t,TIME_PRECISION)}function __t_cmp(t0,t1){if(__adjust(t0)>__adjust(t1))return 1;if(__adjust(t0)<__adjust(t1))return-1;return 0}var C={};C.NOTHING=-1;C.STOPPED=0;C.PLAYING=1;C.PAUSED=2;C.M_CONTROLS_ENABLED=1;C.M_CONTROLS_DISABLED=2;C.M_INFO_ENABLED=4;C.M_INFO_DISABLED=8;C.M_HANDLE_EVENTS=16;C.M_DO_NOT_HANDLE_EVENTS=32;C.M_DRAW_STILL=64;C.M_DO_NOT_DRAW_STILL=128;C.M_INFINITE_DURATION=256;C.M_FINITE_DURATION=512;C.M_PREVIEW=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION;C.M_DYNAMIC=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_INFINITE_DURATION;C.M_VIDEO=C.M_CONTROLS_ENABLED|C.M_INFO_ENABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DRAW_STILL|C.M_FINITE_DURATION;C.M_SANDBOX=C.M_CONTROLS_DISABLED|C.M_INFO_DISABLED|C.M_DO_NOT_HANDLE_EVENTS|C.M_DO_NOT_DRAW_STILL|C.M_FINITE_DURATION;C.__enmap={};function __reg_event(id,name,value){C[id]=value;C.__enmap[value]=name}__reg_event("X_MCLICK","mclick",1);__reg_event("X_MDCLICK","mdclick",2);__reg_event("X_MUP","mup",4);__reg_event("X_MDOWN","mdown",8);__reg_event("X_MMOVE","mmove",16);__reg_event("X_MOVER","mover",32);__reg_event("X_MOUT","mout",64);__reg_event("XT_MOUSE","mouse",C.X_MCLICK|C.X_MDCLICK|C.X_MUP|C.X_MDOWN|C.X_MMOVE|C.X_MOVER|C.X_MOUT);__reg_event("X_KPRESS","kpress",128);__reg_event("X_KUP","kup",256);__reg_event("X_KDOWN","kdown",1024);__reg_event("XT_KEYBOARD","keyboard",C.X_KPRESS|C.X_KUP|C.X_KDOWN);__reg_event("XT_CONTROL","control",C.XT_KEYBOARD|C.XT_MOUSE);__reg_event("X_DRAW","draw",2048);__reg_event("S_PLAY","play","play");__reg_event("S_PAUSE","pause","pause");__reg_event("S_STOP","stop","stop");__reg_event("S_LOAD","load","load");__reg_event("S_REPEAT","repeat","repeat");__reg_event("S_ERROR","error","error");var M={};C.MOD_PLAYER="player";var global_opts={liveDebug:false,autoFocus:true,setTabindex:true};M[C.MOD_PLAYER]=global_opts;function Player(){this.id="";this.state=null;this.anim=null;this.canvas=null;this.ctx=null;this.controls=null;this.info=null;this.__canvasPrepared=false;this.__instanceNum=++Player.__instances;this.__makeSafe(Player._SAFE_METHODS)}Player.__instances=0;Player.PREVIEW_POS=0;Player.PEFF=0;Player.NO_TIME=-1;Player.MARKER_ATTR="anm-player";Player.URL_ATTR="data-url";Player.DEFAULT_CANVAS={width:DEF_CNVS_WIDTH,height:DEF_CNVS_HEIGHT,bgcolor:null};Player.DEFAULT_CONFIGURATION={debug:false,inParent:false,muteErrors:false,repeat:false,mode:C.M_VIDEO,zoom:1,meta:{title:"",author:"Anonymous",copyright:"",version:null,description:""},anim:{fps:30,width:DEF_CNVS_WIDTH,height:DEF_CNVS_HEIGHT,bgcolor:null,duration:0}};Player._SAFE_METHODS=["init","load","play","stop","pause","drawAt"];Player.prototype.init=function(cvs,opts){if(this.canvas)throw new PlayerErr(Errors.P.INIT_TWICE);if(this.anim)throw new PlayerErr(Errors.P.INIT_AFTER_LOAD);this._initHandlers();this._prepare(cvs);this._loadOpts(opts);this._postInit();return this};Player.prototype.load=function(arg1,arg2,arg3,arg4){var player=this;var object=arg1,duration,importer,callback;var durationPassed=false;if(__fun(arg2)){callback=arg2}else if(__num(arg2)){duration=arg2;durationPassed=true;if(__obj(arg3)){importer=arg3;callback=arg4}else if(__fun(arg3)){callback=arg3}}else if(__obj(arg2)){importer=arg2;callback=arg3}if(!object){player.anim=null;player._reset();player.stop();throw new PlayerErr(Errors.P.NO_SCENE_PASSED)}if(player.state.happens===C.PLAYING||player.state.happens===C.PAUSED){throw new PlayerErr(Errors.P.COULD_NOT_LOAD_WHILE_PLAYING)}if(!player.__canvasPrepared)throw new PlayerErr(Errors.P.CANVAS_NOT_PREPARED);player._reset();var whenDone=function(result){if(player.mode&C.M_HANDLE_EVENTS){player.__subscribeDynamicEvents(player.anim)}player.fire(C.S_LOAD);player.stop();if(callback)callback(result)};if(object){if(__builder(object)){L.loadBuilder(player,object,whenDone)}else if(object instanceof Scene){L.loadScene(player,object,whenDone)}else if(__arr(object)){L.loadClips(player,object,whenDone)}else if(__str(object)){L.loadFromUrl(player,object,importer,whenDone)}else{L.loadFromObj(player,object,importer,whenDone)}}else{player.anim=new Scene}if(durationPassed){player.anim.setDuration(duration);player.setDuration(duration)}return player};Player.prototype.play=function(from,speed,stopAfter){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.ALREADY_PLAYING);var player=this;__nextFrame=__frameFunc();player._ensureHasAnim();player._ensureHasState();var state=player.state;state.__lastPlayConf=[from,speed,stopAfter];if(state.duration==undefined)throw new PlayerErr(Errors.P.DURATION_IS_NOT_KNOWN);state.from=from||state.from;state.speed=speed||state.speed;state.stop=typeof stopAfter!=="undefined"?stopAfter:state.stop;state.__startTime=Date.now();state.__redraws=0;state.__rsec=0;state.__supressFrames=false;state.happens=C.PLAYING;var scene=player.anim;scene.reset();player.setDuration(scene.duration);state.__firstReq=__r_loop(player.ctx,state,scene,player.__beforeFrame(scene),player.__afterFrame(scene),player.__userBeforeRender,player.__userAfterRender);player.fire(C.S_PLAY,state.from);return player};Player.prototype.stop=function(){var player=this;player._ensureHasState();var state=player.state;if(state.happens===C.PLAYING||state.happens===C.PAUSED){player.__supressFrames=true;__stopAnim(state.__firstReq)}state.time=Player.NO_TIME;state.from=0;state.stop=Player.NO_TIME;if(player.anim){state.happens=C.STOPPED;if(player.mode&C.M_DRAW_STILL){player.drawAt(state.duration*Player.PREVIEW_POS)}if(player.controls){player._renderControlsAt(0)}}else{state.happens=C.NOTHING;player._drawSplash()}player.fire(C.S_STOP);if(player.anim)player.anim.reset();return player};Player.prototype.pause=function(){var player=this;player._ensureHasState();player._ensureHasAnim();var state=player.state;if(state.happens===C.STOPPED){throw new PlayerErr(Errors.P.PAUSING_WHEN_STOPPED)}if(state.happens===C.PLAYING){state.__supressFrames=true;__stopAnim(state.__firstReq)}if(state.time>state.duration){state.time=state.duration}state.from=state.time;state.happens=C.PAUSED;player.drawAt(state.time);player.fire(C.S_PAUSE,state.time);return player};Player.prototype.onerror=function(callback){this.__err_handler=callback;return this};provideEvents(Player,[C.S_PLAY,C.S_PAUSE,C.S_STOP,C.S_LOAD,C.S_REPEAT,C.S_ERROR]);Player.prototype._prepare=function(cvs){if(__str(cvs)){this.canvas=document.getElementById(cvs);if(!this.canvas)throw new PlayerErr(_strf(Errors.P.NO_CANVAS_WITH_ID,[cvs]));this.id=cvs}else{if(!cvs)throw new PlayerErr(Errors.P.NO_CANVAS_PASSED);this.id=cvs.id;this.canvas=cvs}var canvas=this.canvas;if(canvas.getAttribute(Player.MARKER_ATTR))throw new PlayerErr(Errors.P.ALREADY_ATTACHED);canvas.setAttribute(Player.MARKER_ATTR,true);this.ctx=canvas.getContext("2d");this.state=Player.createState(this);this.subscribeEvents(canvas)};Player.prototype._loadOpts=function(opts){var cvs_opts=Player._mergeOpts(Player._optsFromCvsAttrs(this.canvas),Player.DEFAULT_CONFIGURATION);var opts=opts?Player._mergeOpts(opts,cvs_opts):cvs_opts;this.inParent=opts.inParent;this.mode=opts.mode!=null?opts.mode:C.M_VIDEO;this.debug=opts.debug;this.state.zoom=opts.zoom||1;this.state.repeat=opts.repeat;this.configureAnim(opts.anim||Player.DEFAULT_CONFIGURATION.anim);this._checkMode();this.configureMeta(opts.meta||Player.DEFAULT_CONFIGURATION.meta)};Player.prototype._postInit=function(){this.stop();Text._ensureHasBuffer();var mayBeUrl=this.canvas.getAttribute(Player.URL_ATTR);if(mayBeUrl)this.load(mayBeUrl)};Player.prototype.changeRect=function(rect){this._reconfigureCanvas({width:rect.width,height:rect.height,x:rect.x,y:rect.y,bgcolor:this.state.bgcolor})};Player.prototype._rectChanged=function(rect){var cur=this._canvasConf;return cur.width!=rect.width||cur.height!=rect.height||cur.x!=rect.x||cur.y!=rect.y};Player.prototype.forceRedraw=function(){if(this.controls)this.controls.forceNextRedraw();switch(this.state.happens){case C.STOPPED:this.stop();break;case C.PAUSED:if(this.anim)this.drawAt(this.state.time);break;case C.PLAYING:if(this.anim){this._stopAndContinue()}break;case C.NOTHING:this._drawSplash();break}};Player.prototype.changeZoom=function(ratio){this.state.zoom=ratio};Player.prototype.configureAnim=function(conf){this._animInfo=conf;var cnvs=this.canvas;if(!conf.width&&cnvs.hasAttribute("width"))conf.width=cnvs.getAttribute("width");if(!conf.height&&cnvs.hasAttribute("height"))conf.height=cnvs.getAttribute("height");this._reconfigureCanvas(conf);if(conf.bgcolor)this.state.bgcolor=conf.bgcolor;if(conf.fps)this.state.fps=conf.fps;if(conf.duration)this.state.duration=conf.duration};Player.prototype.configureMeta=function(info){this._metaInfo=info;if(this.info)this.info.inject(info,this._animInfo)};Player.prototype.drawAt=function(time){if(time===Player.NO_TIME)throw new PlayerErr(Errors.P.PASSED_TIME_VALUE_IS_NO_TIME);if(time<0||time>this.state.duration){throw new PlayerErr(_strf(Errors.P.PASSED_TIME_NOT_IN_RANGE,[time]))}this.anim.reset();__r_at(time,this.ctx,this.state,this.anim,this.__userBeforeRender,this.__userAfterRender);if(this.controls){this._renderControlsAt(time)}return this};Player.prototype.beforeFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.BEFOREFRAME_BEFORE_PLAY);this.__userBeforeFrame=callback};Player.prototype.afterFrame=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.AFTERFRAME_BEFORE_PLAY);this.__userAfterFrame=callback};Player.prototype.beforeRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.BEFORENDER_BEFORE_PLAY);this.__userBeforeRender=callback};Player.prototype.afterRender=function(callback){if(this.state.happens===C.PLAYING)throw new PlayerErr(Errors.P.AFTERRENDER_BEFORE_PLAY);this.__userAfterRender=callback};Player.prototype.detach=function(){if(this.controls)this.controls.detach(this.canvas);if(this.info)this.info.detach(this.canvas);this.canvas.removeAttribute(Player.MARKER_ATTR);this._reset()};Player.attachedTo=function(canvas){return canvas.getAttribute(Player.MARKER_ATTR)==null||canvas.getAttribute(Player.MARKER_ATTR)==undefined};Player.__getPosAndRedraw=function(player){return function(evt){if(player.controls){player.controls.update(player.canvas)}if(player.info){player.info.update(player.canvas)}}};Player.prototype.subscribeEvents=function(canvas){_window.addEventListener("scroll",Player.__getPosAndRedraw(this),false);_window.addEventListener("resize",Player.__getPosAndRedraw(this),false);this.canvas.addEventListener("mouseover",function(player){return function(evt){if(global_opts.autoFocus&&player.mode&C.M_HANDLE_EVENTS&&player.canvas){player.canvas.focus()}if(player.state.happens===C.NOTHING)return;if(player.controls){player.controls.show();player._renderControls()}if(player.info)player.info.show();return true}}(this),false);this.canvas.addEventListener("mouseout",function(player){return function(evt){if(global_opts.autoFocus&&player.mode&C.M_HANDLE_EVENTS&&player.canvas){player.canvas.blur()}if(player.state.happens===C.NOTHING)return;if(player.controls&&!player.controls.evtInBounds(evt)){player.controls.hide()}if(player.info&&!player.info.evtInBounds(evt)){player.info.hide()}return true}}(this),false)};Player.prototype.setDuration=function(value){this.state.duration=value>=0?value:0;if(this.info)this.info.setDuration(value>=0?value:0)};Player.prototype._drawSplash=function(){var ctx=this.ctx,w=this.state.width,h=this.state.height,rsize=120;ctx.save();var ratio=this.state.ratio;if(ratio!=1)ctx.scale(ratio,ratio);ctx.fillStyle="#ffe";ctx.fillRect(0,0,w,h);ctx.fillStyle="#999966";ctx.font="18px sans-serif";ctx.fillText("Â© Animatron Player",20,h-20);ctx.lineWidth=12;ctx.strokeStyle="#fee";ctx.strokeRect(0,0,w,h);ctx.translate(w/2-rsize/2,h/2-rsize/2);var grad=ctx.createLinearGradient(0,0,rsize,rsize);grad.addColorStop(0,"#00abeb");grad.addColorStop(.7,"#fff");grad.addColorStop(.7,"#6c0");grad.addColorStop(1,"#fff");ctx.fillStyle=grad;ctx.strokeStyle="#bbb";ctx.lineWidth=10;ctx.globalAlpha=.8;ctx.fillRect(0,0,rsize,rsize);ctx.globalAlpha=.9;ctx.strokeRect(0,0,rsize,rsize);ctx.restore()};Player.prototype._drawLoadingSplash=function(text){this._drawSplash();var ctx=this.ctx;ctx.save();ctx.fillStyle="#006";ctx.font="12px sans-serif";ctx.fillText(text||Strings.LOADING,20,25);ctx.restore()};Player.prototype.toString=function(){return"[ Player '"+this.id+"' m-"+this.mode+" ]"};Player.prototype._reset=function(){var state=this.state;state.debug=this.debug;state.happens=C.NOTHING;state.from=0;state.time=Player.NO_TIME;state.duration=undefined;if(this.controls)this.controls.reset();if(this.info)this.info.reset();this.ctx.clearRect(0,0,state.width*state.ratio,state.height*state.ratio)};Player.prototype._stopAndContinue=function(){var state=this.state,last_conf=state.__lastPlayConf;var stoppedAt=state.time;this.stop();this.play(stoppedAt,last_conf[1],last_conf[2])};Player.prototype._reconfigureCanvas=function(opts){var canvas=this.canvas;var pxRatio=getPxRatio();this._canvasConf=opts;var _w=opts.width?Math.floor(opts.width):DEF_CNVS_WIDTH;var _h=opts.height?Math.floor(opts.height):DEF_CNVS_HEIGHT;opts.width=_w;opts.height=_h;this.state.width=_w;this.state.height=_h;this.state.ratio=pxRatio;if(opts.bgcolor)this.state.bgcolor=opts.bgcolor;canvasOpts(canvas,opts,pxRatio);Player._saveCanvasPos(canvas);if(this.controls)this.controls.update(canvas);if(this.info)this.info.update(canvas);this.__canvasPrepared=true;this.forceRedraw();return this};Player.prototype._enableControls=function(){this.controls=new Controls(this);this.controls.update(this.canvas)};Player.prototype._disableControls=function(){this.controls.detach(this.canvas);this.controls=null};Player.prototype._enableInfo=function(){this.info=new InfoBlock(this);this.info.update(this.canvas)};Player.prototype._disableInfo=function(){this.info.detach(this.canvas);this.info=null};Player.prototype._renderControls=function(){this._renderControlsAt(this.state.time)};Player.prototype._renderControlsAt=function(t){this.controls.render(this.state,t)};Player.prototype._checkMode=function(){if(!this.canvas)return;if(this.mode&C.M_CONTROLS_ENABLED){if(!this.controls)this._enableControls()}else{if(this.controls)this._disableControls()}if(this.mode&C.M_INFO_ENABLED){if(!this.info)this._enableInfo()}else{if(this.info)this._disableInfo()}};Player.prototype.__subscribeDynamicEvents=function(scene){if(global_opts.setTabindex){this.canvas.setAttribute("tabindex",this.__instanceNum)}if(scene&&!scene.__subscribedEvts){scene.subscribeEvents(this.canvas);scene.__subscribedEvts=true}};Player.prototype._ensureHasState=function(){if(!this.state)throw new PlayerErr(Errors.P.NO_STATE)};Player.prototype._ensureHasAnim=function(){if(!this.anim)throw new PlayerErr(Errors.P.NO_SCENE)};Player.prototype.__beforeFrame=function(scene){return function(player,state,scene,callback){return function(time){if(state.happens!==C.PLAYING)return false;if(state.stop!==Player.NO_TIME&&time>=state.from+state.stop||time>state.duration+Player.PEFF){state.time=0;scene.reset();player.stop();if(state.repeat){player.play();player.fire(C.S_REPEAT)}else if(!(player.mode&C.M_INFINITE_DURATION)&&__finite(state.duration)){player.drawAt(state.duration)}return false}if(callback)callback(time,player.ctx);return true}}(this,this.state,scene,this.__userBeforeFrame)};Player.prototype.__afterFrame=function(scene){return function(player,state,scene,callback){return function(time){if(player.controls){player._renderControls()}if(callback)callback(time);return true}}(this,this.state,scene,this.__userAfterFrame)};Player.prototype.__onerror=function(err){var player=this;var doMute=player.state&&player.state.muteErrors;doMute=doMute&&!(err instanceof SysErr);try{player.fire(C.S_ERROR,err);player.anim=null;player.__unsafe_stop()}catch(e){throw new SysErr(_strf(Errors.S.ERROR_HANDLING_FAILED,[err.message||err]))}doMute=this.__err_handler&&this.__err_handler(err)||doMute;if(!doMute)throw err};Player.prototype.__callSafe=function(f){try{return f.call(this)}catch(err){this.__onerror(err)}};Player.prototype.__makeSafe=function(methods){var player=this;for(var i=0,il=methods.length;i<il;i++){var method=methods[i];if(!player[method])throw new SysErr(_strf(Errors.S.NO_METHOD_FOR_PLAYER,[method]));player["__unsafe_"+method]=player[method];player[method]=function(method_f){return function(){var args=arguments;if(!this.__safe_ctx){this.__safe_ctx=true;try{var ret_val=player.__callSafe(function(){return method_f.apply(player,args)});this.__safe_ctx=false;return ret_val}catch(err){this.__safe_ctx=false;throw err}}else{return method_f.apply(player,args)}}}(player[method])}};Player._saveCanvasPos=function(cvs){var gcs=document.defaultView&&document.defaultView.getComputedStyle;var cpl=gcs?parseInt(gcs(cvs,null).paddingLeft,10)||0:0,cpt=gcs?parseInt(gcs(cvs,null).paddingTop,10)||0:0,cbl=gcs?parseInt(gcs(cvs,null).borderLeftWidth,10)||0:0,cbt=gcs?parseInt(gcs(cvs,null).borderTopWidth,10)||0:0;var html=document.body.parentNode,htol=html.offsetLeft,htot=html.offsetTop;var elm=cvs,ol=cpl+cbl+htol,ot=cpt+cbt+htot;if(elm.offsetParent!==undefined){do{ol+=elm.offsetLeft;ot+=elm.offsetTop}while(elm=elm.offsetParent)}ol+=cpl+cbl+htol;ot+=cpt+cbt+htot;cvs.__rOffsetLeft=ol;cvs.__rOffsetTop=ot};Player.createState=function(player){return{time:Player.NO_TIME,from:0,stop:Player.NO_TIME,speed:1,fps:30,afps:0,duration:0,debug:false,iactive:false,width:player.canvas.offsetWidth,height:player.canvas.offsetHeight,zoom:1,bgcolor:null,happens:C.NOTHING,duration:undefined,__startTime:-1,__redraws:0,__rsec:0}};function __attrOr(canvas,attr,_default){return canvas.hasAttribute(attr)?canvas.getAttribute(attr):_default}Player._mergeOpts=function(what,where){var res=_mrg_obj(what,where);res.meta=what.meta?_mrg_obj(what.meta,where.meta||{}):where.meta||{};res.anim=what.anim?_mrg_obj(what.anim,where.anim||{}):where.anim||{};return res};Player._optsFromCvsAttrs=function(canvas){var width,height,pxRatio=getPxRatio();return{debug:__attrOr(canvas,"data-debug",undefined),inParent:undefined,muteErrors:__attrOr(canvas,"data-mute-errors",false),repeat:__attrOr(canvas,"data-repeat",undefined),mode:__attrOr(canvas,"data-mode",undefined),zoom:__attrOr(canvas,"data-zoom",undefined),meta:{title:__attrOr(canvas,"data-title",undefined),author:__attrOr(canvas,"data-author",undefined),copyright:undefined,version:undefined,description:undefined},anim:{fps:undefined,width:__attrOr(canvas,"data-width",(width=__attrOr(canvas,"width",undefined),width?width/pxRatio:undefined)),height:__attrOr(canvas,"data-height",(height=__attrOr(canvas,"height",undefined),height?height/pxRatio:undefined)),bgcolor:canvas.hasAttribute("data-bgcolor")?{color:canvas.getAttribute("data-bgcolor")}:undefined,duration:undefined}}};Player._optsFromUrlParams=function(params){return{debug:params.debug,inParent:undefined,muteErrors:false,repeat:params.r,mode:params.m,zoom:params.z,anim:{fps:undefined,width:params.w,height:params.h,bgcolor:{color:params.bg?"#"+params.bg:null},duration:undefined}}};Player.forSnapshot=function(canvasId,snapshotUrl,importer){var urlWithParams=snapshotUrl.split("?"),snapshotUrl=urlWithParams[0],urlParams=urlWithParams[1],params=urlParams&&urlParams.length>0?__paramsToObj(urlParams):{},options=Player._optsFromUrlParams(params),player=new Player;player.init(canvasId,options);function updateWithParams(){if(typeof params.t!=="undefined"){player.play(params.t/100)}else if(typeof params.p!=="undefined"){player.play(params.p/100).pause()}if(params.w&&params.h){player._reconfigureCanvas({width:params.w,height:params.h})}if(params.bg)player.canvas.style.backgroundColor="#"+params.bg}player.load(snapshotUrl,importer,updateWithParams);return player};function Scene(){this.tree=[];this.hash={};this.name="";this.duration=undefined;this.bgfill=null;this.width=undefined;this.height=undefined;this._initHandlers()}Scene.DEFAULT_LEN=10;provideEvents(Scene,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW]);Scene.prototype.setDuration=function(val){this.duration=val>=0?val:0};Scene.prototype.add=function(arg1,arg2,arg3){if(arg2){var _elm=new Element(arg1,arg2);if(arg3)_elm.changeTransform(arg3);this._addToTree(_elm);return _elm}else if(__arr(arg1)){var _clip=new Clip;_clip.add(arg1);this._addToTree(_clip);return _clip}else if(__builder(arg1)){this._addToTree(arg1.value)}else{this._addToTree(arg1)}};Scene.prototype.remove=function(elm){if(elm.parent){elm.parent.remove(elm)}else{this._unregister(elm)}};Scene.prototype.visitElems=function(visitor,data){for(var elmId in this.hash){visitor(this.hash[elmId],data)}};Scene.prototype.visitRoots=function(visitor,data){for(var i=0,tlen=this.tree.length;i<tlen;i++){visitor(this.tree[i],data)}};Scene.prototype.render=function(ctx,time,zoom){ctx.save();if(zoom!=1){ctx.scale(zoom,zoom)}if(this.bgfill){ctx.fillStyle=Brush.create(ctx,this.bgfill);ctx.fillRect(0,0,this.width,this.height)}this.visitRoots(function(elm){elm.render(ctx,time)});ctx.restore();this.fire(C.X_DRAW,ctx)};Scene.prototype.handle__x=function(type,evt){this.visitElems(function(elm){if(elm.visible)elm.fire(type,evt)});return true};Scene.prototype.getFittingDuration=function(){var max_pos=-Infinity;var me=this;this.visitRoots(function(elm){var elm_tpos=elm._max_tpos();if(elm_tpos>max_pos)max_pos=elm_tpos});return max_pos};Scene.prototype.reset=function(){this.visitRoots(function(elm){elm.reset()})};Scene.prototype.dispose=function(){this.disposeHandlers();var me=this;this.visitRoots(function(elm){me._unregister(elm);elm.dispose()})};Scene.prototype.isEmpty=function(){return this.tree.length==0};Scene.prototype.toString=function(){return"[ Scene "+(this.name?"'"+this.name+"'":"")+"]"};Scene.prototype.subscribeEvents=function(canvas){var anim=this;canvas.addEventListener("mouseup",function(evt){anim.fire(C.X_MUP,mevt(evt,canvas))},false);canvas.addEventListener("mousedown",function(evt){anim.fire(C.X_MDOWN,mevt(evt,canvas))},false);canvas.addEventListener("mousemove",function(evt){anim.fire(C.X_MMOVE,mevt(evt,canvas))},false);canvas.addEventListener("mouseover",function(evt){anim.fire(C.X_MOVER,mevt(evt,canvas))},false);canvas.addEventListener("mouseout",function(evt){anim.fire(C.X_MOUT,mevt(evt,canvas))},false);canvas.addEventListener("click",function(evt){anim.fire(C.X_MCLICK,mevt(evt,canvas))},false);canvas.addEventListener("dblclick",function(evt){anim.fire(C.X_MDCLICK,mevt(evt,canvas))},false);canvas.addEventListener("keyup",function(evt){anim.fire(C.X_KUP,kevt(evt))},false);canvas.addEventListener("keydown",function(evt){anim.fire(C.X_KDOWN,kevt(evt))},false);canvas.addEventListener("keypress",function(evt){anim.fire(C.X_KPRESS,kevt(evt))},false)};Scene.prototype._addToTree=function(elm){if(!elm.children){throw new AnimErr("It appears that it is not a clip object or element that you pass")}this._register(elm);this.tree.push(elm)};Scene.prototype._register=function(elm){if(this.hash[elm.id])throw new AnimErr(Errors.A.ELEMENT_IS_REGISTERED);elm.registered=true;elm.scene=this;this.hash[elm.id]=elm;var me=this;elm.visitChildren(function(elm){me._register(elm)})};Scene.prototype._unregister=function(elm){if(!elm.registered)throw new AnimErr(Errors.A.ELEMENT_IS_NOT_REGISTERED);var me=this;elm.visitChildren(function(elm){me._unregister(elm)});var pos=-1;while((pos=this.tree.indexOf(elm))>=0){this.tree.splice(pos,1)}delete this.hash[elm.id];elm.registered=false;elm.scene=null};C.R_ONCE=0;C.R_STAY=1;C.R_LOOP=2;C.R_BOUNCE=3;C.C_SRC_OVER=1;C.C_SRC_ATOP=2;C.C_SRC_IN=3;C.C_SRC_OUT=4;C.C_DST_OVER=5;C.C_DST_ATOP=6;C.C_DST_IN=7;C.C_DST_OUT=8;C.C_LIGHTER=9;C.C_DARKER=10;C.C_COPY=11;C.C_XOR=12;C.AC_NAMES=[];C.AC_NAMES[C.C_SRC_OVER]="source-over";C.AC_NAMES[C.C_SRC_ATOP]="source-atop";C.AC_NAMES[C.C_SRC_IN]="source-in";C.AC_NAMES[C.C_SRC_OUT]="source-out";C.AC_NAMES[C.C_DST_OVER]="destination-over";C.AC_NAMES[C.C_DST_ATOP]="destination-atop";C.AC_NAMES[C.C_DST_IN]="destination-in";C.AC_NAMES[C.C_DST_OUT]="destination-out";C.AC_NAMES[C.C_LIGHTER]="lighter";C.AC_NAMES[C.C_DARKER]="darker";C.AC_NAMES[C.C_COPY]="copy";C.AC_NAMES[C.C_XOR]="xor";Element.TYPE_MAX_BIT=16;Element.PRRT_MAX_BIT=8;Element.SYS_MOD=0;Element.TWEEN_MOD=1;Element.USER_MOD=2;Element.EVENT_MOD=3;Element.FIRST_MOD=Element.SYS_MOD;Element.LAST_MOD=Element.EVENT_MOD;
Element.ALL_MODIFIERS=[Element.SYS_MOD,Element.TWEEN_MOD,Element.USER_MOD,Element.EVENT_MOD];Element.NOEVT_MODIFIERS=[Element.SYS_MOD,Element.TWEEN_MOD,Element.USER_MOD];Element.SYS_PNT=0;Element.USER_PNT=1;Element.DEBUG_PNT=2;Element.FIRST_PNT=Element.SYS_PNT;Element.LAST_PNT=Element.DEBUG_PNT;Element.ALL_PAINTERS=[Element.SYS_PNT,Element.USER_PNT,Element.DEBUG_PNT];Element.NODBG_PAINTERS=[Element.SYS_PNT,Element.USER_PNT];function Element(draw,onframe){this.id=guid();this.name="";this.state=Element.createState(this);this.xdata=Element.createXData(this);this.children=[];this.parent=null;this.scene=null;this.visible=false;this.registered=false;this.disabled=false;this.rendering=false;this.__data=null;this._modifiers=[];this._painters=[];if(onframe)this.__modify({type:Element.USER_MOD},onframe);if(draw)this.__paint({type:Element.USER_PNT},draw);this.__lastJump=null;this.__jumpLock=false;this.__modifying=null;this.__painting=null;this.__evtCache=[];this.__detachQueue=[];this._initHandlers();var _me=this,default_on=this.on;this.on=function(type,handler){if(type&C.XT_CONTROL){this.m_on.call(_me,type,handler)}else default_on.call(_me,type,handler)};Element.__addSysModifiers(this);Element.__addSysPainters(this);if(global_opts.liveDebug)Element.__addDebugRender(this)}Element.NO_BAND=null;Element.DEFAULT_LEN=Infinity;provideEvents(Element,[C.X_MCLICK,C.X_MDCLICK,C.X_MUP,C.X_MDOWN,C.X_MMOVE,C.X_MOVER,C.X_MOUT,C.X_KPRESS,C.X_KUP,C.X_KDOWN,C.X_DRAW]);Element.prototype.prepare=function(){this.state._matrix.reset();return true};Element.prototype.onframe=function(ltime){return this.__callModifiers(Element.ALL_MODIFIERS,ltime)};Element.prototype.drawTo=function(ctx){return this.__callPainters(Element.ALL_PAINTERS,ctx)};Element.prototype.draw=Element.prototype.drawTo;Element.prototype.transform=function(ctx){var s=this.state;s._matrix=Element._getMatrixOf(s,s._matrix);ctx.globalAlpha*=s.alpha;s._matrix.apply(ctx)};Element.prototype.render=function(ctx,gtime){if(this.disabled)return;this.rendering=true;ctx.save();var wasDrawn=false;var ltime=this.ltime(gtime);if(wasDrawn=this.fits(ltime)&&this.onframe(ltime)&&this.prepare()){if(!this.__mask){this.transform(ctx);this.draw(ctx);this.visitChildren(function(elm){elm.render(ctx,gtime)})}else{this.__ensureHasMaskCanvas();var mcvs=this.__maskCvs,mctx=this.__maskCtx,bcvs=this.__backCvs,bctx=this.__backCtx;var scene_width=this.scene.width,scene_height=this.scene.height,dbl_scene_width=scene_width*2,dbl_scene_height=scene_height*2;bctx.save();bctx.clearRect(0,0,dbl_scene_width,dbl_scene_height);bctx.save();bctx.translate(scene_width,scene_height);this.transform(bctx);this.visitChildren(function(elm){elm.render(bctx,gtime)});this.draw(bctx);bctx.restore();bctx.globalCompositeOperation="destination-in";mctx.save();mctx.clearRect(0,0,dbl_scene_width,dbl_scene_height);mctx.translate(scene_width,scene_height);this.__mask.render(mctx,gtime);mctx.restore();bctx.drawImage(mcvs,0,0,dbl_scene_width,dbl_scene_height);bctx.restore();ctx.drawImage(bcvs,-scene_width,-scene_height,dbl_scene_width,dbl_scene_height)}}this.visible=wasDrawn;ctx.restore();this.__postRender();this.rendering=false;if(wasDrawn)this.fire(C.X_DRAW,ctx)};Element.prototype.addModifier=function(modifier,easing,data,priority){if(__obj(modifier)){modifier.type=Element.USER_MOD;return this.__modify(modifier,easing)}else{return this.__modify({type:Element.USER_MOD,priority:priority,easing:easing,data:data},modifier)}};Element.prototype.addTModifier=function(time,modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,time:time,easing:easing,data:data},modifier)};Element.prototype.addRModifier=function(modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,easing:easing,relative:true,data:data},modifier)};Element.prototype.addRTModifier=function(time,modifier,easing,data,priority){return this.__modify({type:Element.USER_MOD,priority:priority,time:time,easing:easing,relative:true,data:data},modifier)};Element.prototype.removeModifier=function(modifier){if(!modifier.__m_ids)throw new AnimErr(Errors.A.MODIFIER_NOT_ATTACHED);var id=modifier.__m_ids[this.id];if(!id)throw new AnimErr("Modifier wasn't applied to this element");var TB=Element.TYPE_MAX_BIT,PB=Element.PRRT_MAX_BIT;var type=id>>TB,priority=id-(type<<TB)>>PB,i=id-(type<<TB)-(priority<<PB);this._modifiers[type][priority][i]=null};Element.prototype.addPainter=function(painter,data,priority){return this.__paint({type:Element.USER_PNT,priority:priority,data:data},painter)};Element.prototype.removePainter=function(painter){if(!painter.__p_ids)throw new AnimErr("Painter wasn't applied to anything");var id=painter.__p_ids[this.id];var TB=Element.TYPE_MAX_BIT,PB=Element.PRRT_MAX_BIT;var type=id>>TB,priority=id-(type<<TB)>>PB,i=id-(type<<TB)-(priority<<PB);this._painters[type][priority][i]=null};Element.prototype.addTween=function(tween){return Element.__addTweenModifier(this,tween)};Element.prototype.changeTransform=function(transform){this.transform=function(elm,new_,prev){return function(ctx){new_.call(elm,ctx,prev)}}(this,transform,this.transform)};Element.prototype.add=function(arg1,arg2,arg3){if(arg2){var _elm=new Element(arg1,arg2);if(arg3)_elm.changeTransform(arg3);this._addChild(_elm);return _elm}else if(__arr(arg1)){this._addChildren(arg1)}else if(__builder(arg1)){this._addChild(arg1.v)}else{this._addChild(arg1)}};Element.prototype.__safeDetach=function(what,_cnt){var pos=-1,found=_cnt||0;var children=this.children;if((pos=children.indexOf(what))>=0){if(this.rendering||what.rendering){this.__detachQueue.push(what)}else{if(this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);what._unbind();children.splice(pos,1)}return 1}else{this.visitChildren(function(ielm){found+=ielm.__safeDetach(what,found)});return found}};Element.prototype.remove=function(elm){if(!elm)throw new AnimErr(Errors.A.NO_ELEMENT_TO_REMOVE);if(this.__safeDetach(elm)==0)throw new AnimErr(Errors.A.NO_ELEMENT)};Element.prototype._unbind=function(){if(this.parent.__unsafeToRemove||this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);this.parent=null;if(this.scene)this.scene._unregister(this)};Element.prototype.detach=function(){if(this.parent.__safeDetach(this)==0)throw new AnimErr(Errors.A.ELEMENT_NOT_ATTACHED)};Element.prototype.makeBandFit=function(){var wband=this.findWrapBand();this.xdata.gband=wband;this.xdata.lband[1]=wband[1]-wband[0]};Element.prototype.setBand=function(band){this.xdata.lband=band;Bands.recalc(this)};Element.prototype.duration=function(){return this.xdata.lband[1]-this.xdata.lband[0]};Element.prototype._max_tpos=function(){return this.xdata.gband[1]>=0?this.xdata.gband[1]:0};Element.prototype.fits=function(ltime){if(ltime<0)return false;return __t_cmp(ltime,this.xdata.lband[1]-this.xdata.lband[0])<=0};Element.prototype.gtime=function(ltime){return this.xdata.gband[0]+ltime};Element.prototype.ltime=function(gtime){var x=this.xdata;if(!__finite(x.gband[1]))return this.__checkJump(gtime-x.gband[0]);switch(x.mode){case C.R_ONCE:return this.__checkJump(gtime-x.gband[0]);case C.R_STAY:return __t_cmp(gtime,x.gband[1])<=0?this.__checkJump(gtime-x.gband[0]):this.__checkJump(x.lband[1]-x.lband[0]);case C.R_LOOP:{var p=this.parent,px=p?p.xdata:null;var durtn=x.lband[1]-x.lband[0],pdurtn=p?px.lband[1]-px.lband[0]:durtn;if(durtn<0)return-1;var ffits=(gtime-x.gband[0])/durtn,fits=Math.floor(ffits);if(fits<0||ffits>x.nrep)return-1;var t=gtime-x.gband[0]-fits*durtn;return this.__checkJump(t)}case C.R_BOUNCE:{var p=this.parent,px=p?p.xdata:null;var durtn=x.lband[1]-x.lband[0],pdurtn=p?px.lband[1]-px.lband[0]:durtn;if(durtn<0)return-1;var ffits=(gtime-x.gband[0])/durtn,fits=Math.floor(ffits);if(fits<0||ffits>x.nrep)return-1;var t=gtime-x.gband[0]-fits*durtn,t=fits%2===0?t:durtn-t;return this.__checkJump(t)}}};Element.prototype.m_on=function(type,handler){return this.__modify({type:Element.EVENT_MOD},function(t){if(this.__evt_st&type){var evts=this.__evts[type];for(var i=0;i<evts.length;i++){if(handler.call(this,evts[i],t)===false)return false}}})};Element.prototype.findWrapBand=function(){var children=this.children;if(children.length===0)return this.xdata.gband;var result=[Infinity,0];this.visitChildren(function(elm){result=Bands.expand(result,elm.xdata.gband)});return result[0]!==Infinity?result:null};Element.prototype.dispose=function(){this.disposeHandlers();this.disposeXData();this.visitChildren(function(elm){elm.dispose()})};Element.prototype.disposeXData=function(){if(this.xdata.path)this.xdata.path.dispose();if(this.xdata.text)this.xdata.text.dispose();if(this.xdata.sheet)this.xdata.sheet.dispose()};Element.prototype.reset=function(){this.__resetState();this.__lastJump=null;if(this.__mask)this.__removeMaskCanvases();(function(elm){elm.__forAllModifiers(function(modifier){if(modifier.__wasCalled)modifier.__wasCalled[elm.id]=false;if(modifier.__wasCalledAt)modifier.__wasCalledAt[elm.id]=-1})})(this);this.visitChildren(function(elm){elm.reset()})};Element.prototype.visitChildren=function(func){var children=this.children;this.__unsafeToRemove=true;for(var ei=0,el=children.length;ei<el;ei++){func(children[ei])}this.__unsafeToRemove=false};Element.prototype.travelChildren=function(func){var children=this.children;this.__unsafeToRemove=true;for(var ei=0,el=children.length;ei<el;ei++){var elem=children[ei];func(elem);elem.travelChildren(func)}this.__unsafeToRemove=false};Element.prototype.iterateChildren=function(func,rfunc){this.__unsafeToRemove=true;iter(this.children).each(func,rfunc);this.__unsafeToRemove=false};Element.prototype.hasChildren=function(){return this.children.length>0};Element.prototype.deepIterateChildren=function(func,rfunc){this.__unsafeToRemove=true;iter(this.children).each(function(elem){elem.deepIterateChildren(func,rfunc);return func(elem)},rfunc);this.__unsafeToRemove=false};Element.prototype.__performDetach=function(){var children=this.children;iter(this.__detachQueue).each(function(elm){if((idx=children.indexOf(elm))>=0){children.splice(idx,1);elm._unbind()}});this.__detachQueue=[]};Element.prototype.clear=function(){if(this.__unsafeToRemove)throw new AnimErr(Errors.A.UNSAFE_TO_REMOVE);if(!this.rendering){var children=this.children;this.children=[];iter(children).each(function(elm){elm._unbind()})}else{this.__detachQueue=this.__detachQueue.concat(this.children)}};Element.prototype.lock=function(){this.__jumpLock=true;this.__lstate=obj_clone(this.state);this.__pstate=this._state?obj_clone(this._state):null};Element.prototype.unlock=function(){var result=this.state;this.state=this.__lstate;this._state=this.__pstate;this.__lstate=null;this.__jumpLock=false;return result};Element.prototype.stateAt=function(t){this.lock();var success=this.__callModifiers(Element.NOEVT_MODIFIERS,t);var state=this.unlock();return success?state:null};Element.prototype.offset=function(){var xsum=0,ysum=0;var p=this.parent;while(p){var ps=p.state;xsum+=ps.lx+ps.x;ysum+=ps.ly+ps.y;p=p.parent}return[xsum,ysum]};Element.prototype.lbounds=function(){var x=this.xdata;if(x.__bounds)return x.__bounds;var subj=x.path||x.text||x.sheet;if(subj)return subj.bounds()};Element.prototype.lrect=function(){var b=this.lbounds();if(!b)return null;return[b[0],b[1],b[2],b[1],b[2],b[3],b[0],b[3]]};Element.prototype.setMask=function(elm){if(!elm)throw new AnimErr("No valid masking element was passed");if(this.scene)this.__ensureHasMaskCanvas();this.__mask=elm};Element.prototype.__ensureHasMaskCanvas=function(){if(this.__maskCvs||this.__backCvs)return;var scene=this.scene;if(!scene)throw new AnimErr("Element to be masked should be attached to scene when rendering");this.__maskCvs=newCanvas([scene.width*2,scene.height*2],this.state.ratio);this.__maskCtx=this.__maskCvs.getContext("2d");this.__backCvs=newCanvas([scene.width*2,scene.height*2],this.state.ratio);this.__backCtx=this.__backCvs.getContext("2d")};Element.prototype.__removeMaskCanvases=function(){if(this.__maskCvs){disposeElm(this.__maskCvs);this.__maskCvs=null;this.__maskCtx=null}if(this.__backCvs){disposeElm(this.__backCvs);this.__backCvs=null;this.__backCtx=null}};Element.prototype.clearMask=function(){this.__mask=null;this.__removeMaskCanvases()};Element.prototype.data=function(val){if(typeof val!=="undefined")return this.__data=val;return this.__data};Element.prototype.toString=function(){var buf=["[ Element "];buf.push("'"+(this.name||this.id)+"' ");buf.push("]");return buf.join("")};Element.prototype.clone=function(){var clone=new Element;clone.name=this.name;clone.children=[].concat(this.children);clone._modifiers=[].concat(this._modifiers);clone._painters=[].concat(this._painters);clone.xdata=obj_clone(this.xdata);clone.xdata.$=clone;clone.__data=this.__data;return clone};Element.prototype.deepClone=function(){var clone=this.clone();clone.children=[];var src_children=this.children;var trg_children=clone.children;for(var sci=0,scl=src_children.length;sci<scl;sci++){var csrc=src_children[sci],cclone=csrc.deepClone();cclone.parent=clone;trg_children.push(cclone)}clone._modifiers=[];for(var mti=0,mtl=this._modifiers.length;mti<mtl;mti++){var type_group=this._modifiers[mti];if(!type_group)continue;clone._modifiers[mti]=[];for(var mpi=0,mpl=type_group.length;mpi<mpl;mpi++){var priority_group=type_group[mpi];if(!priority_group)continue;clone._modifiers[mti][mpi]=[].concat(priority_group);for(mi=0,ml=priority_group.length;mi<ml;mi++){var modifier=priority_group[mi];if(modifier&&modifier.__m_ids){modifier.__m_ids[clone.id]=modifier.__m_ids[this.id]}}}}clone._painters=[];for(var pti=0,ptl=this._painters.length;pti<ptl;pti++){var type_group=this._painters[pti];if(!type_group)continue;clone._painters[pti]=[];for(var ppi=0,ppl=type_group.length;ppi<ppl;ppi++){var priority_group=type_group[ppi];if(!priority_group)continue;clone._painters[pti][ppi]=[].concat(priority_group);for(pi=0,pl=priority_group.length;pi<pl;pi++){var painter=priority_group[pi];if(painter&&painter.__p_ids){painter.__p_ids[clone.id]=painter.__p_ids[this.id]}}}}clone.__data=obj_clone(this.__data);var src_x=this.xdata,trg_x=clone.xdata;if(src_x.path)trg_x.path=src_x.path.clone();if(src_x.text)trg_x.text=src_x.text.clone();if(src_x.sheet)trg_x.sheet=src_x.sheet.clone();trg_x.pos=[].concat(src_x.pos);trg_x.reg=[].concat(src_x.reg);trg_x.lband=[].concat(src_x.lband);trg_x.gband=[].concat(src_x.gband);trg_x.keys=obj_clone(src_x.keys);return clone};Element.prototype._addChild=function(elm){elm.parent=this;this.children.push(elm);if(this.scene)this.scene._register(elm);Bands.recalc(this)};Element.prototype._addChildren=function(elms){for(var ei=0,el=elms.length;ei<el;ei++){this._addChild(elms[ei])}};Element.prototype._stateStr=function(){var state=this.state;return"x: "+s.x+" y: "+s.y+"\n"+"lx: "+s.lx+" ly: "+s.ly+"\n"+"rx: "+s.rx+" ry: "+s.ry+"\n"+"sx: "+s.sx+" sy: "+s.sy+"\n"+"angle: "+s.angle+" alpha: "+s.alpha+"\n"+"p: "+s.p+" t: "+s.t+" key: "+s.key+"\n"};Element.prototype.__adaptModTime=function(ltime,conf,state,modifier){var lband=this.xdata.lband,elm_duration=lband[1]-lband[0],easing=conf.easing,time=conf.time,relative=conf.relative;var _tpair=null;if(time==null){_tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)]}else if(__arr(time)){var band=time;if(!relative){var mod_duration=band[1]-band[0];if(__t_cmp(ltime,band[0])<0)return false;if(__t_cmp(ltime,band[1])>0)return false;_tpair=[__adjust(ltime-band[0]),__adjust(mod_duration)]}else{var abs_band=[band[0]*elm_duration,band[1]*elm_duration];var mod_duration=abs_band[1]-abs_band[0];if(__t_cmp(ltime,abs_band[0])<0)return false;if(__t_cmp(ltime,abs_band[1])>0)return false;_tpair=[__adjust(ltime-abs_band[0])/__adjust(mod_duration),__adjust(mod_duration)]}}else if(__num(time)){if(modifier.__wasCalled&&modifier.__wasCalled[this.id])return false;var tpos=relative?time*elm_duration:time;if(__t_cmp(ltime,tpos)>=0){if(!modifier.__wasCalled)modifier.__wasCalled={};if(!modifier.__wasCalledAt)modifier.__wasCalledAt={};modifier.__wasCalled[this.id]=true;modifier.__wasCalledAt[this.id]=ltime}else return false;_tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)]}else _tpair=[relative?__adjust(ltime)/__adjust(elm_duration):__adjust(ltime),__adjust(elm_duration)];return!easing?_tpair:[easing(_tpair[0],_tpair[1]),_tpair[1]]};Element.prototype.__callModifiers=function(order,ltime){return function(elm){elm.state._=null;elm._state=Element.createState(elm);elm._state._=obj_clone(elm.state);elm.__loadEvts(elm._state);if(!elm.__forAllModifiers(order,function(modifier,conf){var lbtime=elm.__adaptModTime(ltime,conf,elm._state,modifier);if(lbtime===false)return true;return modifier.call(elm._state,lbtime[0],lbtime[1],conf.data)},function(type){elm.__modifying=type;elm.__mbefore(type)},function(type){elm.__mafter(ltime,type,true)})){elm.__mafter(ltime,elm.__modifying,false);elm.__modifying=null;elm.__clearEvts(elm._state);return false}elm.__modifying=null;elm._state._applied=true;elm._state._appliedAt=ltime;elm.__clearEvts(elm._state);elm.state=elm._state;elm._state=null;return true}(this)};Element.prototype.__callPainters=function(order,ctx){(function(elm){elm.__forAllPainters(order,function(painter,conf){painter.call(elm.xdata,ctx,conf.data)},function(type){elm.__painting=type;elm.__pbefore(ctx,type)},function(type){elm.__pafter(ctx,type)});elm.__painting=null})(this)};Element.prototype.__addTypedModifier=function(conf,modifier){if(!modifier)throw new AnimErr(Errors.A.NO_MODIFIER_PASSED);var modifiers=this._modifiers;var elm_id=this.id;if(!modifier.__m_ids)modifier.__m_ids={};else if(modifier.__m_ids[elm_id])throw new AnimErr(Errors.A.MODIFIER_REGISTERED);var priority=conf.priority||0,type=conf.type;if(!modifiers[type])modifiers[type]=[];if(!modifiers[type][priority])modifiers[type][priority]=[];modifiers[type][priority].push([modifier,{type:type,priority:priority,time:conf.time,relative:conf.relative,easing:Element.__convertEasing(conf.easing,null,conf.relative),data:conf.data}]);modifier.__m_ids[elm_id]=type<<Element.TYPE_MAX_BIT|priority<<Element.PRRT_MAX_BIT|modifiers[type][priority].length-1;return modifier};Element.prototype.__modify=Element.prototype.__addTypedModifier;Element.prototype.__forAllModifiers=function(order,f,before_type,after_type){var modifiers=this._modifiers;var type,seq,cur;for(var typenum=0,last=order.length;typenum<last;typenum++){type=order[typenum];seq=modifiers[type];if(before_type)before_type(type);if(seq){for(var pi=0,pl=seq.length;pi<pl;pi++){if(cur=seq[pi]){for(var ci=0,cl=cur.length;ci<cl;ci++){var modifier;if(modifier=cur[ci]){if(f(modifier[0],modifier[1])===false)return false}}}}}if(after_type)after_type(type)}return true};Element.prototype.__addTypedPainter=function(conf,painter){if(!painter)throw new AnimErr(Errors.A.NO_PAINTER_PASSED);var painters=this._painters;var elm_id=this.id;if(!painter.__p_ids)painter.__p_ids={};else if(painter.__p_ids[elm_id])throw new AnimErr(Errors.A.PAINTER_REGISTERED);var priority=conf.priority||0,type=conf.type;if(!painters[type])painters[type]=[];if(!painters[type][priority])painters[type][priority]=[];painters[type][priority].push([painter,{type:type,priority:priority,data:conf.data}]);painter.__p_ids[elm_id]=type<<Element.TYPE_MAX_BIT|priority<<Element.PRRT_MAX_BIT|painters[type][priority].length-1;return painter};Element.prototype.__paint=Element.prototype.__addTypedPainter;Element.prototype.__forAllPainters=function(order,f,before_type,after_type){var painters=this._painters;var type,seq,cur;for(var typenum=0,last=order.length;typenum<last;typenum++){type=order[typenum];seq=painters[type];if(before_type)before_type(type);if(seq){for(var pi=0,pl=seq.length;pi<pl;pi++){if(cur=seq[pi]){for(var ci=0,cl=cur.length;ci<cl;ci++){if(cur[ci])f(cur[ci][0],cur[ci][1])}}}}if(after_type)after_type(type)}return true};Element.prototype.__mbefore=function(t,type){};Element.prototype.__mafter=function(t,type,result){};Element.prototype.__pbefore=function(ctx,type){};Element.prototype.__pafter=function(ctx,type){};Element.prototype.__checkJump=function(at){var x=this.xdata,s=this.state;if(x.tf)return x.tf(at);var t=null,duration=x.lband[1]-x.lband[0];t=s.p!==null?s.p:null;t=t===null&&s.t!==null?s.t*duration:t;t=t===null&&s.key!==null?x.keys[s.key]:t;if(t!==null){if(t<0||t>duration){throw new AnimErr("failed to calculate jump")}if(!this.__jumpLock){this.__lastJump=[at,t];s.p=null;s.t=null;s.key=null;return t}}t=t!==null?t:at;if(this.__lastJump!==null){return this.__lastJump[1]+(t-this.__lastJump[0])}return t};Element.prototype.handle__x=function(type,evt){this.__saveEvt(type,evt);return true};Element.prototype.__saveEvt=function(type,evt){this.__evtCache.push([type,evt])};Element.prototype.__loadEvts=function(to){var cache=this.__evtCache;var cache_len=cache.length;this.__clearEvts(to);if(cache_len>0){var edata,type,evts;for(var ei=0;ei<cache_len;ei++){edata=cache[ei];type=edata[0];to.__evt_st|=type;evts=to.__evts;if(!evts[type])evts[type]=[];evts[type].push(edata[1])}this.__evtCache=[]}};Element.prototype.__clearEvts=function(from){from.__evt_st=0;from.__evts={}};Element.prototype.__postRender=function(){this.__performDetach()};Element.prototype.__resetState=function(){var s=this.state;s.x=0;s.y=0;s.lx=0;s.ly=0;s.rx=0;s.ry=0;s.angle=0;s.alpha=1;s.sx=1;s.sy=1;s.p=null;s.t=null;s.key=null;s._applied=false;s._appliedAt=null;s._matrix.reset()};Element.createState=function(owner){return{x:0,y:0,lx:0,ly:0,rx:0,ry:0,angle:0,sx:1,sy:1,alpha:1,p:null,t:null,key:null,_matrix:new Transform,_evts:{},_evt_st:0,$:owner}};Element.createXData=function(owner){return{pos:[0,0],reg:[0,0],path:null,text:null,sheet:null,mode:C.R_ONCE,nrep:Infinity,lband:[0,Element.DEFAULT_LEN],gband:[0,Element.DEFAULT_LEN],keys:{},tf:null,acomp:null,_mpath:null,$:owner}};Element.__addSysModifiers=function(elm){elm.__modify({type:Element.SYS_MOD},Render.m_saveReg);elm.__modify({type:Element.SYS_MOD},Render.m_applyPos)};Element.__addSysPainters=function(elm){elm.__paint({type:Element.SYS_PNT},Render.p_applyAComp);elm.__paint({type:Element.SYS_PNT},Render.p_drawXData)};Element.__addDebugRender=function(elm){elm.__paint({type:Element.SYS_PNT},Render.p_drawReg);elm.__paint({type:Element.SYS_PNT},Render.p_drawName);elm.on(C.X_DRAW,Render.h_drawMPath)};Element.__addTweenModifier=function(elm,conf){var tween_f=Tweens[conf.type](),m_tween;if(conf.relative){m_tween=tween_f}else{m_tween=function(t,duration,data){return tween_f.call(this,t/duration,duration,data)}}return elm.__modify({type:Element.TWEEN_MOD,priority:Tween.TWEENS_PRIORITY[conf.type],time:conf.band||conf.time,relative:conf.relative,easing:conf.easing,data:conf.data},m_tween)};Element.__convertEasing=function(easing,data,relative){if(!easing)return null;if(__str(easing)){var f=EasingImpl[easing](data);return relative?f:function(t,len){return f(t/len,len)*len}}if(__fun(easing)&&!data)return easing;if(__fun(easing)&&data)return easing(data);if(easing.type){var f=EasingImpl[easing.type](easing.data||data);return relative?f:function(t,len){return f(t/len,len)*len}}if(easing.f)return easing.f(easing.data||data)};Element._getMatrixOf=function(s,m){var _t=m?(m.reset(),m):new Transform;_t.translate(s.lx,s.ly);_t.translate(s.x,s.y);_t.rotate(s.angle);_t.scale(s.sx,s.sy);_t.translate(-s.rx,-s.ry);return _t};Element._getIMatrixOf=function(s,m){var _t=Element._getMatrixOf(s,m);_t.invert();return _t};var Clip=Element;function provideEvents(subj,events){subj.prototype._initHandlers=function(evts){return function(){var _hdls={};this.handlers=_hdls;for(var ei=0;ei<evts.length;ei++){_hdls[evts[ei]]=[]}}}(events);subj.prototype.on=function(event,handler){if(!this.provides(event))throw new AnimErr("Event '"+C.__enmap[event]+"' not provided by "+this);if(!handler)throw new AnimErr("You are trying to assign "+"undefined handler for event "+event);this.handlers[event].push(handler);return this.handlers[event].length-1};subj.prototype.fire=function(event,evtobj){if(!this.provides(event))throw new AnimErr("Event '"+C.__enmap[event]+"' not provided by "+this);if(this.disabled)return;if(this.handle__x&&!this.handle__x(event,evtobj))return;var name=C.__enmap[event];if(this["handle_"+name])this["handle_"+name](evtobj);var _hdls=this.handlers[event];for(var hi=0;hi<_hdls.length;hi++){_hdls[hi].call(this,evtobj)}};subj.prototype.provides=function(evts){return function(event){if(!event)return evts;return this.handlers.hasOwnProperty(event)}}(events);subj.prototype.unbind=function(event,idx){if(!this.provides(event))throw new AnimErr("Event "+event+" not provided by "+this);if(this.handlers[event][idx]){this.handlers[event].splice(idx,1)}else{throw new AnimErr("No such handler "+idx+" for event "+event)}};subj.prototype.disposeHandlers=function(){var _hdls=this.handlers;for(var evt in _hdls){if(_hdls.hasOwnProperty(evt))_hdls[evt]=[]}};var _event;for(var ei=0;ei<events.length;ei++){_event=events[ei];subj.prototype["e_"+_event]=function(event){return function(evtobj){this.fire(event,evtobj)}}(_event)}}function kevt(e){return{key:e.keyCode!=null?e.keyCode:e.which,ch:e.charCode}}function mevt(e,cvs){return{pos:[e.pageX-cvs.__rOffsetLeft,e.pageY-cvs.__rOffsetTop]}}var L={};L.loadFromUrl=function(player,url,importer,callback){if(!JSON)throw new SysErr(Errors.S.NO_JSON_PARSER);player._drawLoadingSplash(_strf(Strings.LOADING_ANIMATION,[url.substring(0,50)]));ajax(url,function(req){L.loadFromObj(player,JSON.parse(req.responseText),importer,callback)})};L.loadFromObj=function(player,object,importer,callback){if(!importer)throw new PlayerErr(Errors.P.NO_IMPORTER_TO_LOAD_WITH);if(importer.configureAnim){player.configureAnim(importer.configureAnim(object))}if(importer.configureMeta){player.configureMeta(importer.configureMeta(object))}L.loadScene(player,importer.load(object),callback)};L.loadScene=function(player,scene,callback){if(player.anim)player.anim.dispose();if(player.state.debug&&!global_opts.liveDebug)scene.visitElems(Element.__addDebugRender);player.anim=scene;if(player.state.duration==undefined){var _duration;if(scene.duration!==undefined){_duration=scene.duration}else{if(player.mode&C.M_INFINITE_DURATION){_duration=Infinity}else{if(scene.isEmpty()){_duration=0}else{_duration=Scene.DEFAULT_LEN}}}scene.setDuration(_duration);player.setDuration(_duration)}if(scene.width===undefined&&scene.height===undefined){scene.width=player.state.width;scene.height=player.state.height}if(callback)callback.call(player,scene)};L.loadClips=function(player,clips,callback){var _anim=new Scene;_anim.add(clips);L.loadScene(player,_anim,callback)};L.loadBuilder=function(player,builder,callback){var _anim=new Scene;_anim.add(builder.v);if(builder.d!=undefined)_anim.setDuration(builder.d);L.loadScene(player,_anim,callback)};var Render={};function __r_loop(ctx,pl_state,scene,before,after,before_render,after_render){if(pl_state.happens!==C.PLAYING)return;var msec=Date.now()-pl_state.__startTime;var sec=msec/1e3;var time=sec*pl_state.speed+pl_state.from;pl_state.time=time;if(before){if(!before(time))return}if(pl_state.__rsec===0)pl_state.__rsec=msec;if(msec-pl_state.__rsec>=1e3){pl_state.afps=pl_state.__redraws;pl_state.__rsec=msec;pl_state.__redraws=0}pl_state.__redraws++;__r_at(time,ctx,pl_state,scene,before_render,after_render);if(pl_state.debug){__r_fps(ctx,pl_state.afps,time)}if(after){if(!after(time))return}if(pl_state.__supressFrames)return;return __nextFrame(function(){__r_loop(ctx,pl_state,scene,before,after,before_render,after_render)})}function __r_at(time,ctx,pl_state,scene,before,after){ctx.save();var ratio=pl_state.ratio;if(ratio!=1)ctx.scale(ratio,ratio);var size_differs=pl_state.width!=scene.width||pl_state.height!=scene.height;if(!size_differs){ctx.clearRect(0,0,scene.width,scene.height);if(before)before(time,ctx);scene.render(ctx,time,pl_state.zoom);if(after)after(time,ctx);ctx.restore()}else{__r_with_ribbons(ctx,pl_state.width,pl_state.height,scene.width,scene.height,function(_scale){ctx.clearRect(0,0,scene.width,scene.height);if(before)before(time,ctx);scene.render(ctx,time,pl_state.zoom);if(after)after(time,ctx);ctx.restore()})}}function __r_with_ribbons(ctx,pw,ph,sw,sh,draw_f){var xw=pw/sw,xh=ph/sh;var x=Math.min(xw,xh);var hcoord=(pw-sw*x)/2,vcoord=(ph-sh*x)/2;var scaled=xw!=1||xh!=1;if(scaled){ctx.save();ctx.save();ctx.fillStyle="#000";if(hcoord!=0){ctx.fillRect(0,0,hcoord,ph);ctx.fillRect(hcoord+sw*x,0,hcoord,ph)}if(vcoord!=0){ctx.fillRect(0,0,pw,vcoord);ctx.fillRect(0,vcoord+sh*x,pw,vcoord)}ctx.restore();ctx.beginPath();ctx.rect(hcoord,vcoord,sw*x,sh*x);ctx.clip();ctx.translate(hcoord,vcoord);ctx.scale(x,x)}draw_f(x);if(scaled){ctx.restore()}}function __r_fps(ctx,fps,time){ctx.fillStyle="#999";ctx.font="20px sans-serif";ctx.fillText(Math.floor(fps),8,20);ctx.font="10px sans-serif";ctx.fillText(Math.floor(time*1e3)/1e3,8,35)}Render.loop=__r_loop;Render.at=__r_at;Render._drawFPS=__r_fps;Render.p_drawReg=function(ctx,reg){if(!(reg=reg||this.reg))return;ctx.save();ctx.translate(reg[0],reg[1]);ctx.beginPath();ctx.lineWidth=1;ctx.strokeStyle="#600";ctx.moveTo(0,-10);ctx.lineTo(0,0);ctx.moveTo(3,0);ctx.arc(0,0,3,0,Math.PI*2,true);ctx.closePath();ctx.stroke();ctx.restore()};Render.p_drawXData=function(ctx){var subj=this.path||this.text||this.sheet;if(!subj)return;subj.apply(ctx)};Render.p_drawName=function(ctx,name){if(!(name=name||this.$.name))return;ctx.save();ctx.fillStyle="#666";ctx.font="12px sans-serif";ctx.fillText(name,0,10);ctx.restore()};Render.p_applyAComp=function(ctx){if(this.acomp)ctx.globalCompositeOperation=C.AC_NAMES[this.acomp]};Render.h_drawMPath=function(ctx,mPath){if(!(mPath=mPath||this.state._mpath))return;ctx.save();var s=this.state;ctx.translate(s.lx,s.ly);mPath.cstroke("#600",2);ctx.beginPath();mPath.apply(ctx);ctx.closePath();ctx.stroke();ctx.restore()};Render.m_checkBand=function(time,duration,band){if(band[0]>duration*time)return false;if(band[1]<duration*time)return false};Render.m_saveReg=function(time,duration,reg){if(!(reg=reg||this.$.xdata.reg))return;this.rx=reg[0];this.ry=reg[1]};Render.m_applyPos=function(time,duration,pos){if(!(pos=pos||this.$.xdata.pos))return;this.lx=pos[0];this.ly=pos[1]};var Bands={};Bands.recalc=function(elm,in_band){var x=elm.xdata;var in_band=in_band||(elm.parent?elm.parent.xdata.gband:[0,0]);x.gband=[in_band[0]+x.lband[0],in_band[0]+x.lband[1]];elm.visitChildren(function(celm){Bands.recalc(celm,x.gband)})};Bands.wrap=function(outer,inner){if(!outer)return inner;return[outer[0]+inner[0],outer[0]+inner[1]<=outer[1]?outer[0]+inner[1]:outer[1]]};Bands.expand=function(from,to){if(!from)return to;return[to[0]<from[0]?to[0]:from[0],to[1]>from[1]?to[1]:from[1]]};Bands.reduce=function(from,to){if(!from)return to;return[to[0]>from[0]?to[0]:from[0],to[1]<from[1]?to[1]:from[1]]};C.T_TRANSLATE="TRANSLATE";C.T_SCALE="SCALE";C.T_ROTATE="ROTATE";C.T_ROT_TO_PATH="ROT_TO_PATH";C.T_ALPHA="ALPHA";C.T_SHEAR="SHEAR";var Tween={};var Easing={};Tween.TWEENS_PRIORITY={};Tween.TWEENS_PRIORITY[C.T_TRANSLATE]=0;Tween.TWEENS_PRIORITY[C.T_SCALE]=1;Tween.TWEENS_PRIORITY[C.T_ROTATE]=2;Tween.TWEENS_PRIORITY[C.T_ROT_TO_PATH]=3;Tween.TWEENS_PRIORITY[C.T_ALPHA]=4;Tween.TWEENS_PRIORITY[C.T_SHEAR]=5;Tween.TWEENS_COUNT=6;var Tweens={};Tweens[C.T_ROTATE]=function(){return function(t,duration,data){this.angle=data[0]*(1-t)+data[1]*t}};Tweens[C.T_TRANSLATE]=function(){return function(t,duration,data){var p=data.pointAt(t);this._mpath=data;this.x=p[0];this.y=p[1]}};Tweens[C.T_ALPHA]=function(){return function(t,duration,data){this.alpha=data[0]*(1-t)+data[1]*t}};Tweens[C.T_SCALE]=function(){return function(t,duration,data){this.sx=data[0][0]*(1-t)+data[1][0]*t;this.sy=data[0][1]*(1-t)+data[1][1]*t}};Tweens[C.T_ROT_TO_PATH]=function(){return function(t,duration,data){var path=this._mpath;if(path)this.angle=path.tangentAt(t)}};Tweens[C.T_SHEAR]=function(){return function(t,duration,data){}};C.E_PATH="PATH";C.E_FUNC="FUNC";C.E_CSEG="CSEG";var EasingImpl={};EasingImpl[C.E_PATH]=function(path){return function(t){return path.pointAt(t)[1]
}};EasingImpl[C.E_FUNC]=function(f){return f};EasingImpl[C.E_CSEG]=function(seg){return function(t){return seg.atT([0,0],t)[1]}};Easing.__SEGS={};function __registerSegEasing(alias,points){C["E_"+alias]=alias;var seg=new CSeg(points);Easing.__SEGS[alias]=seg;var func=function(t){return seg.atT([0,0],t)[1]};C["EF_"+alias]=func;EasingImpl[alias]=function(){return func}}__registerSegEasing("DEF",[.25,.1,.25,1,1,1]);__registerSegEasing("IN",[.42,0,1,1,1,1]);__registerSegEasing("OUT",[0,0,.58,1,1,1]);__registerSegEasing("INOUT",[.42,0,.58,1,1,1]);__registerSegEasing("SIN",[.47,0,.745,.715,1,1]);__registerSegEasing("SOUT",[.39,.575,.565,1,1,1]);__registerSegEasing("SINOUT",[.445,.05,.55,.95,1,1]);__registerSegEasing("QIN",[.55,.085,.68,.53,1,1]);__registerSegEasing("QOUT",[.25,.46,.45,.94,1,1]);__registerSegEasing("QINOUT",[.455,.03,.515,.955,1,1]);__registerSegEasing("CIN",[.55,.055,.675,.19,1,1]);__registerSegEasing("COUT",[.215,.61,.355,1,1,1]);__registerSegEasing("CINOUT",[.645,.045,.355,1,1,1]);__registerSegEasing("QTIN",[.895,.03,.685,.22,1,1]);__registerSegEasing("QTOUT",[.165,.84,.44,1,1,1]);__registerSegEasing("QTINOUT",[.77,0,.175,1,1,1]);__registerSegEasing("QIIN",[.755,.05,.855,.06,1,1]);__registerSegEasing("QIOUT",[.23,1,.32,1,1,1]);__registerSegEasing("QIINOUT",[.86,0,.07,1,1,1]);__registerSegEasing("EIN",[.95,.05,.795,.035,1,1]);__registerSegEasing("EOUT",[.19,1,.22,1,1,1]);__registerSegEasing("EINOUT",[1,0,0,1,1,1]);__registerSegEasing("CRIN",[.6,.04,.98,.335,1,1]);__registerSegEasing("CROUT",[.075,.82,.165,1,1,1]);__registerSegEasing("CRINOUT",[.785,.135,.15,.86,1,1]);__registerSegEasing("BIN",[.6,-.28,.735,.045,1,1]);__registerSegEasing("BOUT",[.175,.885,.32,1.275,1,1]);__registerSegEasing("BINOUT",[.68,-.55,.265,1.55,1,1]);C.P_MOVETO=0;C.P_LINETO=1;C.P_CURVETO=2;C.PC_ROUND="round";C.PC_BUTT="butt";C.PC_MITER="miter";C.PC_SQUARE="square";C.PC_BEVEL="bevel";function Path(str,fill,stroke){this.str=str;this.fill=fill;this.stroke=stroke;this.segs=[];this.parse(str)}Path.DEFAULT_CAP=C.PC_ROUND;Path.DEFAULT_JOIN=C.PC_ROUND;Path.EMPTY_FILL={color:"transparent"};Path.DEFAULT_FILL=Path.EMPTY_FILL;Path.BASE_FILL={color:"#fff666"};Path.EMPTY_STROKE={width:0,color:"transparent"};Path.DEFAULT_STROKE=Path.EMPTY_STROKE;Path.BASE_STROKE={width:1,color:"#000",cap:Path.DEFAULT_CAP,join:Path.DEFAULT_JOIN};Path.prototype.visit=function(visitor,data){var segments=this.segs;for(var si=0;si<segments.length;si++){visitor(segments[si],data)}};Path.prototype.length=function(){var sum=0;var p=this.start();this.visit(function(segment){sum+=segment.length(p);p=segment.last()});return sum};Path.prototype.add=function(seg){this.segs.push(seg)};Path.prototype.apply=function(ctx){var p=this;Path.applyF(ctx,p.fill||Path.DEFAULT_FILL,p.stroke||Path.DEFAULT_STROKE,function(){p.visit(Path._applyVisitor,ctx)})};Path.prototype.cstroke=function(color,width,cap,join){this.stroke={width:width!=null?width:Path.DEFAULT_STROKE.width,color:color,cap:cap||Path.DEFAULT_CAP,join:join||Path.DEFAULT_JOIN}};Path.prototype.cfill=function(color){this.fill={color:color}};Path.prototype.parse=function(str){if(str)Path.parse(str,this);return this};Path.prototype.hitAt=function(t){var startp=this.start();if(t===0)return{seg:this.segs[0],start:startp,slen:0,segt:0};var endp=this.end();var plen=this.length();var nsegs=this.segs.length;var distance=t*plen;var p=startp;var length=0;var seg,slen;for(var si=0;si<nsegs;si++){seg=this.segs[si];slen=seg.length(p);if(distance<=length+slen){var segdist=distance-length;return{seg:seg,start:p,slen:slen,segt:slen!=0?segdist/slen:0}}length+=slen;p=seg.last()}var lseg=this.segs[this.segs.length-1];return{seg:lseg,start:p,slen:lseg.length(p),segt:1}};Path.prototype.pointAt=function(t){var hit=this.hitAt(t);return hit.seg.atT(hit.start,hit.segt)};Path.prototype.tangentAt=function(t){var hit=this.hitAt(t);return hit.seg.tangentAt(hit.start,hit.segt)};Path.prototype.start=function(){if(this.segs.length<1)return null;return[this.segs[0].pts[0],this.segs[0].pts[1]]};Path.prototype.end=function(){if(this.segs.length<1)return null;var lastidx=this.segs.length-1;var s=this.segs[lastidx].count;return[this.segs[lastidx].pts[s-2],this.segs[lastidx].pts[s-1]]};Path.prototype.bounds=function(){if(this.segs.length<=0)return[0,0,0,0];var minX=this.segs[0].pts[0],maxX=this.segs[0].pts[0],minY=this.segs[0].pts[1],maxY=this.segs[0].pts[1];this.visit(function(segment){var pts=segment.pts;for(var pi=0;pi<pts.length;pi+=2){minX=Math.min(minX,pts[pi]);maxX=Math.max(maxX,pts[pi])}for(var pi=1;pi<pts.length;pi+=2){minY=Math.min(minY,pts[pi]);maxY=Math.max(maxY,pts[pi])}});return[minX,minY,maxX,maxY]};Path.prototype.rect=function(){var b=this.bounds();return[b[0],b[1],b[2],b[1],b[2],b[3],b[0],b[3]]};Path.prototype.vpoints=function(func){this.visit(function(segment){var pts=segment.pts;for(var pi=0;pi<pts.length;pi+=2){var res=func(pts[pi],pts[pi+1]);if(res){pts[pi]=res[0];pts[pi+1]=res[1]}}})};Path.prototype.shift=function(pt){this.vpoints(function(x,y){return[x+pt[0],y+pt[1]]})};Path.prototype.zoom=function(vals){this.vpoints(function(x,y){return[x*vals[0],y*vals[1]]})};Path.prototype.normalize=function(){var bounds=this.bounds();var w=bounds[2]-bounds[0],h=bounds[3]-bounds[1];var hw=Math.floor(w/2),hh=Math.floor(h/2);var min_x=bounds[0],min_y=bounds[1];this.vpoints(function(x,y){return[x-min_x-hw,y-min_y-hh]});return[hw,hh]};Path.prototype.getPoints=function(){var points=[];this.visit(function(seg){points=points.concat(seg.pts)});return points};Path.prototype.toString=function(){return"[ Path '"+Path.toSVGString(this)+"' ]"};Path.prototype.duplicate=function(){var seg_copy=new Path;this.visit(function(seg){seg_copy.add(Path.makeSeg(seg.type,[].concat(seg.pts)))});return seg_copy};Path.prototype.clone=function(){var clone=this.duplicate();if(this.stroke)clone.stroke=obj_clone(this.stroke);if(this.fill)clone.fill=obj_clone(this.fill);return clone};Path.prototype.dispose=function(){};Path.applyF=function(ctx,fill,stroke,func){ctx.save();ctx.beginPath();Brush.fill(ctx,fill);Brush.stroke(ctx,stroke);func();if(Brush._hasVal(fill))ctx.fill();if(Brush._hasVal(stroke))ctx.stroke();ctx.restore()};Path.visitStrPath=function(path,visitor,data){var cur_pos=0;while(true){var marker=path[cur_pos];if(marker==="Z"){visitor(marker,[],data);return}var pos_data=null;if(marker==="M"||marker==="L"){pos_data=Path._collectPositions(path,cur_pos,2)}else if(marker==="C"){pos_data=Path._collectPositions(path,cur_pos,6)}cur_pos+=pos_data[0];var positions=pos_data[1];visitor(marker,positions,data)}};Path.toSVGString=function(path){var buffer=[];path.visit(Path._encodeVisitor,buffer);buffer.push("Z");return buffer.join(" ")};Path._collectPositions=function(path,start,count){var pos=start+1;var positions=[];var got=0;while(got!=count){var posstr=__collect_to(path,pos," ");pos+=posstr.length+1;got++;positions.push(parseFloat(posstr))}return[pos-start,positions]};Path._parserVisitor=function(marker,positions,path){if(marker==="M"){path.add(new MSeg(positions))}else if(marker==="L"){path.add(new LSeg(positions))}else if(marker==="C"){path.add(new CSeg(positions))}};Path._strApplyVisitor=function(marker,positions,ctx){if(marker==="M"){ctx.moveTo(positions[0],positions[1])}else if(marker==="L"){ctx.lineTo(positions[0],positions[1])}else if(marker==="C"){ctx.bezierCurveTo(positions[0],positions[1],positions[2],positions[3],positions[4],positions[5])}};Path._applyVisitor=function(segment,ctx){var type=segment.type;var positions=segment.pts;if(type===C.P_MOVETO){ctx.moveTo(positions[0],positions[1])}else if(type===C.P_LINETO){ctx.lineTo(positions[0],positions[1])}else if(type===C.P_CURVETO){ctx.bezierCurveTo(positions[0],positions[1],positions[2],positions[3],positions[4],positions[5])}};Path._encodeVisitor=function(segment,buffer){var type=segment.type;var positions=segment.pts;if(type===C.P_MOVETO){buffer.push("M"+positions[0]+" "+positions[1])}else if(type===C.P_LINETO){buffer.push("L"+positions[0]+" "+positions[1])}else if(type===C.P_CURVETO){buffer.push("C"+positions[0]+" "+positions[1]+" "+positions[2]+" "+positions[3]+" "+positions[4]+" "+positions[5])}};Path.parse=function(path,target){var target=target||new Path;target.segs=[];Path.visitStrPath(path,Path._parserVisitor,target);target.str=path;return target};Path.parseAndApply=function(ctx,path){Path.visitStrPath(path,Path._strApplyVisitor,ctx)};Path.makeSeg=function(type,pts){if(type===C.P_MOVETO){return new MSeg(pts)}else if(type===C.P_LINETO){return new LSeg(pts)}else if(type===C.P_CURVETO){return new CSeg(pts)}};function MSeg(pts){this.type=C.P_MOVETO;this.pts=pts;this.count=pts.length}MSeg.prototype.length=function(start){return 0};MSeg.prototype.atDist=function(start,dist){return[this.pts[0],this.pts[1]]};MSeg.prototype.atT=function(start,t){return this.atDist(start,null)};MSeg.prototype.tangentAt=function(start,t){return Math.atan2(this.pts[0],this.pts[1])};MSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]};function LSeg(pts){this.type=C.P_LINETO;this.pts=pts;this.count=pts.length}LSeg.prototype.length=function(start){var dx=this.pts[0]-start[0];var dy=this.pts[1]-start[1];return Math.sqrt(dx*dx+dy*dy)};LSeg.prototype.atDist=function(start,dist){return this.atT(start,dist/this.length(start))};LSeg.prototype.atT=function(start,t){var p0x=start[0];var p0y=start[1];var p1x=this.pts[0];var p1y=this.pts[1];return[p0x+(p1x-p0x)*t,p0y+(p1y-p0y)*t]};LSeg.prototype.tangentAt=function(start,t){return Math.atan2(this.pts[1]-start[1],this.pts[0]-start[0])};LSeg.prototype.last=function(){return[this.pts[0],this.pts[1]]};function CSeg(pts){this.type=C.P_CURVETO;this.pts=pts;this.count=pts.length}CSeg.prototype.length=function(start){var positions=this.pts;var p0x=start[0];var p0y=start[1];var p1x=positions[0];var p1y=positions[1];var p2x=positions[2];var p2y=positions[3];var p3x=positions[4];var p3y=positions[5];var p0to1=Math.sqrt(Math.pow(p1x-p0x,2)+Math.pow(p1y-p0y,2));var p1to2=Math.sqrt(Math.pow(p2x-p1x,2)+Math.pow(p2y-p1y,2));var p2to3=Math.sqrt(Math.pow(p3x-p2x,2)+Math.pow(p3y-p2y,2));var len=p0to1+p1to2+p2to3+1;var count=len*3;var dt=1/len;var q1=3*dt;var q2=q1*dt;var q3=dt*dt*dt;var q4=2*q2;var q5=6*q3;var q6x=p0x-2*p1x+p2x;var q6y=p0y-2*p1y+p2y;var q7x=3*(p1x-p2x)-p0x+p3x;var q7y=3*(p1y-p2y)-p0y+p3y;var bx=p0x;var by=p0y;var dbx=(p1x-p0x)*q1+q6x*q2+q3*q7x;var dby=(p1y-p0y)*q1+q6y*q2+q3*q7y;var ddbx=q6x*q4+q7x*q5;var ddby=q6y*q4+q7y*q5;var dddbx=q7x*q5;var dddby=q7y*q5;var length=0;for(var idx=0;idx<count;idx+=3){var px=bx;var py=by;bx+=dbx;by+=dby;dbx+=ddbx;dby+=ddby;ddbx+=dddbx;ddby+=dddby;length+=Math.sqrt((bx-px)*(bx-px)+(by-py)*(by-py))}return length};CSeg.prototype.atDist=function(start,dist){return this.atT(start,dist/this.length(start))};CSeg.prototype.atT=function(start,t){var tt=t*t,ttt=tt*t,t1=1-t,tt1=t1*t1,tt2=tt1*t1,tt3=3*t*tt1,tt4=3*tt*t1;return[start[0]*tt2+this.pts[0]*tt3+this.pts[2]*tt4+this.pts[4]*ttt,start[1]*tt2+this.pts[1]*tt3+this.pts[3]*tt4+this.pts[5]*ttt]};CSeg.prototype.last=function(){return[this.pts[4],this.pts[5]]};CSeg.prototype.tangentAt=function(start,t){this._ensure_params(start);var par=this._params;var tt=t*t;var p=[3*par[0]*tt+2*par[1]*t+par[2],3*par[4]*tt+2*par[5]*t+par[6]];return Math.atan2(p[1],p[0])};CSeg.prototype._ensure_params=function(start){if(this._lstart&&this._lstart[0]===start[0]&&this._lstart[1]===start[1])return;this._lstart=start;this._params=this._calc_params(start)};CSeg.prototype._calc_params=function(start){var pts=this.pts;var params=[];var p0x=start[0];var p0y=start[1];var p1x=pts[0];var p1y=pts[1];var p2x=pts[2];var p2y=pts[3];var p3x=pts[4];var p3y=pts[5];params[0]=p3x-3*p2x+3*p1x-p0x;params[1]=3*p2x-6*p1x+3*p0x;params[2]=3*p1x-3*p0x;params[3]=p0x;params[4]=p3y-3*p2y+3*p1y-p0y;params[5]=3*p2y-6*p1y+3*p0y;params[6]=3*p1y-3*p0y;params[7]=p0y;return params};function Text(lines,font,fill,stroke){this.lines=lines;this.font=font||Text.DEFAULT_FONT;this.fill=fill||Text.DEFAULT_FILL;this.stroke=stroke||Text.DEFAULT_STROKE;this._bnds=null}Text.DEFAULT_CAP=C.PC_ROUND;Text.DEFAULT_JOIN=C.PC_ROUND;Text.DEFAULT_FFACE="sans-serif";Text.DEFAULT_FSIZE=24;Text.DEFAULT_FONT=Text.DEFAULT_FSIZE+"px "+Text.DEFAULT_FFACE;Text.DEFAULT_FILL={color:"#000"};Text.BASELINE_RULE="bottom";Text.DEFAULT_STROKE=null;Text.prototype.apply=function(ctx,point,baseline){ctx.save();var point=point||[0,0],dimen=this.dimen(),accent=this.accent(dimen[1]);ctx.font=this.font;ctx.textBaseline=baseline||Text.BASELINE_RULE;ctx.translate(point[0],point[1]);if(Brush._hasVal(this.fill)){Brush.fill(ctx,this.fill);ctx.save();this.visitLines(function(line){ctx.fillText(line,0,accent);ctx.translate(0,1.2*accent)});ctx.restore()}if(Brush._hasVal(this.stroke)){Brush.stroke(ctx,this.stroke);ctx.save();this.visitLines(function(line){ctx.strokeText(line,0,accent);ctx.translate(0,1.2*accent)});ctx.restore()}ctx.restore()};Text.prototype.dimen=function(){if(this._dimen)return this._dimen;if(!Text.__buff)throw new SysErr("no Text buffer, bounds call failed");var buff=Text.__buff;buff.style.font=this.font;if(__str(this.lines)){buff.textContent=this.lines}else{buff.textContent=this.lines.join("<br/>")}return this._dimen=[buff.offsetWidth,buff.offsetHeight]};Text.prototype.bounds=function(){var dimen=this.dimen();return[0,0,dimen[0],dimen[1]]};Text.prototype.accent=function(height){return height};Text._createBuffer=function(){var _div=document.createElement("div");_div.style.visibility="hidden";_div.style.position="absolute";_div.style.top=-1e4+"px";_div.style.left=-1e4+"px";var _span=document.createElement("span");_div.appendChild(_span);document.body.appendChild(_div);return _span};Text.prototype.cstroke=function(color,width,cap,join){this.stroke={width:width!=null?width:0,color:color,cap:cap||Text.DEFAULT_CAP,join:join||Text.DEFAULT_JOIN}};Text.prototype.cfill=function(color){this.fill={color:color}};Text.prototype.visitLines=function(func,data){var lines=this.lines;if(__str(lines)){func(lines,data)}else{var line;for(var i=0,ilen=lines.length;i<ilen;i++){line=lines[i];func(line,data)}}};Text.prototype.clone=function(){var c=new Text(this.lines,this.font,this.fill,this.stroke);if(this.lines&&Array.isArray(this.lines)){c.lines=[].concat(this.lines)}if(this.stroke)c.stroke=obj_clone(this.stroke);if(this.fill)c.fill=obj_clone(this.fill);return c};Text.prototype.dispose=function(){};Text._ensureHasBuffer=function(){if(!Text.__buff)Text.__buff=Text._createBuffer()};var Brush={};Brush.create=function(ctx,src){if(src._style)return src._style;src._style=Brush._create(ctx,src);return src._style};Brush._create=function(ctx,brush){if(brush.color)return brush.color;if(brush.lgrad){var src=brush.lgrad,stops=src.stops,dir=src.dir,bounds=src.bounds;var grad=bounds?ctx.createLinearGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3]):ctx.createLinearGradient(dir[0][0],dir[0][1],dir[1][0],dir[1][1]);for(var i=0,slen=stops.length;i<slen;i++){var stop=stops[i];grad.addColorStop(stop[0],stop[1])}return grad}if(brush.rgrad){var src=brush.rgrad,stops=src.stops,dir=src.dir,r=src.r,bounds=src.bounds;var grad=bounds?ctx.createRadialGradient(bounds[0]+dir[0][0]*bounds[2],bounds[1]+dir[0][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[0],bounds[0]+dir[1][0]*bounds[2],bounds[1]+dir[1][1]*bounds[3],Math.max(bounds[2],bounds[3])*r[1]):ctx.createRadialGradient(dir[0][0],dir[0][1],r[0],dir[1][0],dir[1][1],r[1]);for(var i=0,slen=stops.length;i<slen;i++){var stop=stops[i];grad.addColorStop(stop[0],stop[1])}return grad}return null};Brush.stroke=function(ctx,stroke){if(!stroke)return;ctx.lineWidth=stroke.width;ctx.strokeStyle=Brush.create(ctx,stroke);ctx.lineCap=stroke.cap;ctx.lineJoin=stroke.join};Brush.fill=function(ctx,fill){if(!fill)return;ctx.fillStyle=Brush.create(ctx,fill)};Brush._hasVal=function(fsval){return fsval&&(fsval.color||fsval.lgrad||fsval.rgrad)};Sheet.instances=0;function Sheet(src,callback,start_region){this.id=Sheet.instances++;this.src=src;this.dimen=[0,0];this.regions=[[0,0,1,1]];this.regions_f=null;this.cur_region=start_region||0;this.ready=false;this._image=null;this._cvs_cache=null;this.load(callback)}Sheet.cache={};Sheet.prototype.load=function(callback){if(this._image)throw new Error("Already loaded");var cache=Sheet.cache;var me=this;function whenDone(image){me._image=image;me.dimen=[image.width,image.height];me.ready=true;me._drawToCache();if(callback)callback.call(me,image)}var _cached=cache[this.src];if(!_cached){var _img=new Image;_img.onload=function(){_img.__anm_ready=true;_img.isReady=true;whenDone(_img)};cache[this.src]=_img;try{_img.src=this.src}catch(e){throw new SysErr("Image at "+me.src+" is not accessible")}}else{if(_cached.__anm_ready){whenDone(_cached)}else{var cur_onload=_cached.onload;_cached.onload=function(){whenDone(_cached);cur_onload()}}}};Sheet.prototype._drawToCache=function(){if(!this.ready)return;if(this._image.__cvs){this._cvs_cache=this._image.__cvs;return}var _canvas=newCanvas(this.dimen,1);var _ctx=_canvas.getContext("2d");_ctx.drawImage(this._image,0,0,this.dimen[0],this.dimen[1]);this._image.__cvs=_canvas;this._cvs_cache=_canvas};Sheet.prototype.apply=function(ctx){if(!this.ready)return;if(this.cur_region<0)return;var region;if(this.region_f){region=this.region_f(this.cur_region)}else{var r=this.regions[this.cur_region],d=this.dimen;region=[r[0]*d[0],r[1]*d[1],r[2]*d[0],r[3]*d[1]]}this._active_region=region;ctx.drawImage(this._cvs_cache,region[0],region[1],region[2],region[3],0,0,region[2],region[3])};Sheet.prototype.bounds=function(){if(!this.ready||!this._active_region)return[0,0,0,0];var r=this._active_region;return[0,0,r[2],r[3]]};Sheet.prototype.clone=function(){return new Sheet(this.src)};Sheet.prototype.dispose=function(){this._cvs_cache=null};var _Image=Sheet;function Controls(player){this.player=player;this.canvas=null;this.ctx=null;this.ready=false;this.bounds=[];this.hidden=false;this.elapsed=false;this._time=-1e3;this._ratio=1;this._lhappens=C.NOTHING;this._initHandlers();this._inParent=player.inParent}Controls.HEIGHT=26;Controls.MARGIN=8;Controls.OPACITY=.75;Controls.BASE_FGCOLOR="#fff";Controls.BASE_BGCOLOR="#000";Controls._BH=Controls.HEIGHT-(Controls.MARGIN+Controls.MARGIN);Controls._TS=Controls._BH*1.1;Controls._TW=Controls._TS*4.4;Controls._SW=1.3;Controls.FONT="Arial, sans-serif";Controls.FONT_WEIGHT="bold";Controls.FLAT=false;provideEvents(Controls,[C.X_MDOWN,C.X_DRAW]);Controls.prototype.update=function(parent){var _ratio=parent.__pxRatio,_w=parent.width/_ratio,_h=Controls.HEIGHT,_hdiff=parent.height/_ratio-Controls.HEIGHT,_pp=find_pos(parent),_bp=[_pp[0]+parent.clientLeft,_pp[1]+parent.clientTop+_hdiff],_cp=this._inParent?[parent.parentNode.offsetLeft+parent.clientLeft,parent.parentNode.offsetTop+parent.clientTop+_hdiff]:_bp;var _canvas=this.canvas;if(!_canvas){_canvas=newCanvas([_w,_h],_ratio);if(parent.id){_canvas.id="__"+parent.id+"_ctrls"}_canvas.className="anm-controls";_canvas.style.position="absolute";_canvas.style.opacity=Controls.OPACITY;_canvas.style.zIndex=100;_canvas.style.cursor="pointer";_canvas.style.backgroundColor="rgba(0, 0, 0, 0)";this.id=_canvas.id;this.canvas=_canvas;this.ctx=_canvas.getContext("2d");this.subscribeEvents(_canvas);this.hide();this.changeTheme(Controls.BASE_FGCOLOR,Controls.BASE_BGCOLOR)}else{canvasOpts(_canvas,[_w,_h],_ratio)}_canvas.style.left=_cp[0]+"px";_canvas.style.top=_cp[1]+"px";this._ratio=_ratio;this.ctx.font=Controls.FONT_WEIGHT+" "+Math.floor(Controls._TS)+"px "+Controls.FONT;if(!this.ready){var appendTo=this._inParent?parent.parentNode:document.body;if(this._inParent){appendTo.style.position="relative"}appendTo.appendChild(_canvas);this.ready=true}this.bounds=[_bp[0],_bp[1],_bp[0]+_w*_ratio,_bp[1]+_h*_ratio]};Controls.prototype.subscribeEvents=function(canvas){canvas.addEventListener("mousedown",function(controls){return function(evt){controls.fire(C.X_MDOWN,evt)}}(this),false);canvas.addEventListener("mouseout",function(controls){return function(evt){controls.hide()}}(this),false)};Controls.prototype.render=function(state,time){if(this.hidden&&!this.__force)return;var _s=state.happens;if(_s==C.NOTHING)return;var time=time>0?time:0;if(!this.__force&&time===this._time&&_s===this._lhappens)return;this._time=time;this._lhappens=_s;var ctx=this.ctx,_ratio=this._ratio;var _bh=Controls._BH,_w=this.bounds[2]-this.bounds[0],_h=this.bounds[3]-this.bounds[1],_m=Controls.MARGIN,_tw=Controls._TW,_pw=_w/_ratio-(_m*6+_tw+_bh);var front=this.__fgcolor,back=this.__bgcolor;ctx.clearRect(0,0,_w,_h);if(!this.__bggrad&&!Controls.FLAT){var bggrad=ctx.createLinearGradient(0,0,0,_h),bgspec=get_rgb(back);bggrad.addColorStop(0,to_rgba(Math.min(bgspec[0]+120,255),Math.min(bgspec[1]+120,255),Math.min(bgspec[2]+120,255),.7));bggrad.addColorStop(.35,to_rgba(Math.min(bgspec[0]+30,255),Math.min(bgspec[1]+30,255),Math.min(bgspec[2]+30,255),.8));bggrad.addColorStop(.75,to_rgba(bgspec[0],bgspec[1],bgspec[2],.9));bggrad.addColorStop(1,to_rgba(bgspec[0],bgspec[1],bgspec[2]));this.__bggrad=bggrad}ctx.fillStyle=Controls.FLAT?back:this.__bggrad;ctx.fillRect(0,0,_w,_h);ctx.save();if(_ratio!=1)ctx.scale(_ratio,_ratio);ctx.translate(_m,_m);ctx.fillStyle=front;if(_s===C.PLAYING){Controls.__pause_btn(ctx,front)}else if(_s===C.STOPPED){Controls.__play_btn(ctx,front)}else if(_s===C.PAUSED){Controls.__play_btn(ctx,front)}else{Controls.__stop_btn(ctx,front)}ctx.translate(_bh+_m,0);Controls.__progress(ctx,_pw,front,back,time,state.duration);ctx.translate(_pw+_m*2.5,0);Controls.__time(ctx,front,back,this.elapsed?time-state.duration:time);ctx.restore();this.fire(C.X_DRAW,state);this.__force=false};Controls.prototype.hide=function(){this.hidden=true;this.canvas.style.display="none"};Controls.prototype.show=function(){this.hidden=false;this.canvas.style.display="block"};Controls.prototype.reset=function(){this._time=-1e3;this.elapsed=false};Controls.prototype.detach=function(parent){(this._inParent?parent.parentNode:document.body).removeChild(this.canvas)};Controls.prototype.handle_mdown=function(event){if(this.hidden)return;var _lx=event.pageX-this.bounds[0],_ly=event.pageY-this.bounds[1],_bh=Controls._BH,_m=Controls.MARGIN,_tw=Controls._TW,_w=this.bounds[2]-this.bounds[0],_ratio=this._ratio;var _s=this.player.state.happens;if(_s===C.NOTHING)return;if(_lx<_bh+_m+_m){if(_s===C.STOPPED){this.player.play(0)}else if(_s===C.PAUSED){this.player.play(this._time)}else if(_s===C.PLAYING){this.player.pause()}}else if(_lx<_w-(_tw+_m)){var _pw=_w/_ratio-(_m*5+_tw+_bh),_px=_lx-(_bh+_m*3+Controls._SW),_d=this.player.state.duration;var _tpos=_px/(_pw/_d);if(_tpos<0)_tpos=0;if(_tpos>_d)_tpos=d;if(_s===C.PLAYING){this.player.pause();this.player.play(_tpos)}else if(_s===C.PAUSED||_s===C.STOPPED){this.player.state.time=_tpos;this.player.drawAt(_tpos)}}else{this.elapsed=!this.elapsed;if(_s!==C.PLAYING){this.forceNextRedraw();this.render(this.player.state,this._time)}}};Controls.prototype.inBounds=function(point){if(this.hidden)return false;var _b=this.bounds;return point[0]>=_b[0]&&point[0]<=_b[2]&&point[1]>=_b[1]&&point[1]<=_b[3]};Controls.prototype.evtInBounds=function(evt){if(this.hidden)return false;return this.inBounds([evt.pageX,evt.pageY])};Controls.prototype.changeTheme=function(front,back){this.__fgcolor=front;this.__bgcolor=back;this.__bggrad=null};Controls.prototype.forceNextRedraw=function(){this.__force=true};Controls.__play_btn=function(ctx,front){var _bh=Controls._BH;var _shift=2;ctx.beginPath();ctx.moveTo(_shift,0);ctx.lineTo(_shift+_bh*.8,_bh/2);ctx.lineTo(_shift,_bh);ctx.lineTo(_shift,0);ctx.fill();ctx.closePath()};Controls.__pause_btn=function(ctx,front){var _bh=Controls._BH;var _w=_bh/2.4;var _d=_bh-(_w+_w);var _nl=_w+_d;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(_w,0);ctx.lineTo(_w,_bh);ctx.lineTo(0,_bh);ctx.lineTo(0,0);ctx.fill();ctx.closePath();ctx.beginPath();ctx.moveTo(_nl,0);ctx.lineTo(_bh,0);ctx.lineTo(_bh,_bh);ctx.lineTo(_nl,_bh);ctx.lineTo(_nl,0);ctx.fill();ctx.closePath()};Controls.__stop_btn=function(ctx,front){var _bh=Controls._BH;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(_bh,0);ctx.lineTo(_bh,_bh);ctx.lineTo(0,_bh);ctx.lineTo(0,0);ctx.fill();ctx.closePath()};Controls.__time=function(ctx,front,back,time){var _bh=Controls._BH,_mr=Controls.MARGIN,_sw=Controls._SW,_time=Math.abs(time),_h=Math.floor(_time/3600),_m=Math.floor((_time-_h*3600)/60),_s=Math.floor(_time-_h*3600-_m*60);var bgspec=get_rgb(back),darkback=to_rgba(Math.max(bgspec[0]-30,0),Math.max(bgspec[1]-30,0),Math.max(bgspec[2]-30,0),.9);ctx.save();Controls.__separator(ctx,0,0,front,darkback);ctx.fillStyle=front;ctx.textBaseline="top";ctx.fillText((time<0?"-":"")+(_h<10?"0"+_h:_h)+":"+(_m<10?"0"+_m:_m)+":"+(_s<10?"0"+_s:_s),_sw+_mr,0);ctx.restore()};Controls.__progress=function(ctx,_w,front,back,time,duration){var _bh=Controls._BH,_m=Controls.MARGIN,_sw=Controls._SW,_px=_w/duration*time,_lh=_bh*.7,_ly=1;var bgspec=get_rgb(back),darkback=to_rgba(Math.max(bgspec[0]-30,0),Math.max(bgspec[1]-30,0),Math.max(bgspec[2]-30,0),.9);ctx.save();Controls.__separator(ctx,0,0,front,darkback);ctx.translate(_sw+_m,0);ctx.save();ctx.fillStyle=back;Controls.__roundRect(ctx,0,_ly,_w,_lh*1.2,5);ctx.fill();ctx.restore();if(duration==0)return;ctx.save();ctx.fillStyle=front;ctx.globalAlpha*=.95;if(__t_cmp(time,duration)>=0){Controls.__roundRect(ctx,0,_ly+1,_px,_lh,5)}else{Controls.__semiRoundRect(ctx,0,_ly+1,_px,_lh,5)}ctx.fill();ctx.restore();ctx.restore()};Controls.__separator=function(ctx,x,y,color,shadowcolor){var _bh=Controls._BH,_sw=Controls._SW,_ss=2.5;ctx.save();ctx.fillStyle=color;ctx.globalAlpha*=.3;ctx.beginPath();ctx.moveTo(0,-_ss);ctx.lineTo(_sw,-_ss);ctx.lineTo(_sw,_bh+_ss*2);ctx.lineTo(0,_bh+_ss*2);ctx.lineTo(0,-_ss);ctx.fill();ctx.closePath();ctx.fillStyle=shadowcolor;ctx.beginPath();ctx.moveTo(-_sw,-_ss);ctx.lineTo(0,-_ss);ctx.lineTo(0,_bh+_ss*2);ctx.lineTo(-_sw,_bh+_ss*2);ctx.lineTo(-_sw,-_ss);ctx.fill();ctx.closePath();ctx.restore()};Controls.__roundRect=function(ctx,x,y,w,h,r){if(w<2*r)r=w/2;if(h<2*r)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()};Controls.__semiRoundRect=function(ctx,x,y,w,h,r){if(w<2*r)r=w/2;if(h<2*r)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w,y+h);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()};function InfoBlock(player){this.canvas=null;this.ctx=null;this.ready=false;this.hidden=false;this._inParent=player.inParent}InfoBlock.BASE_BGCOLOR=Controls.BASE_BGCOLOR;InfoBlock.BASE_FGCOLOR=Controls.BASE_FGCOLOR;InfoBlock.OPACITY=.75;InfoBlock.PADDING=6;InfoBlock.MARGIN=5;InfoBlock.FONT=Controls.FONT;InfoBlock.DEFAULT_WIDTH=0;InfoBlock.DEFAULT_HEIGHT=60;InfoBlock.prototype.detach=function(parent){(this._inParent?parent.parentNode:document.body).removeChild(this.canvas)};InfoBlock.prototype.update=function(parent){var _ratio=parent.__pxRatio,_p=InfoBlock.PADDING,_m=InfoBlock.MARGIN,_w=InfoBlock.DEFAULT_WIDTH,_h=InfoBlock.DEFAULT_HEIGHT-(_p+_p),_pp=this._inParent?[parent.parentNode.offsetLeft+parent.clientLeft,parent.parentNode.offsetTop+parent.clientTop]:find_pos(parent),_l=_pp[0]+parent.clientLeft+_m,_t=_pp[1]+parent.clientTop+_m;var _canvas=this.canvas;if(!_canvas){_canvas=newCanvas([_w,_h],_ratio);if(parent.id){_canvas.id="__"+parent.id+"_info"}_canvas.className="anm-info";_canvas.style.position="absolute";_canvas.style.opacity=InfoBlock.OPACITY;_canvas.style.zIndex=100;_canvas.style.backgroundColor="rgba(0, 0, 0, 0)";this.canvas=_canvas;this.ctx=_canvas.getContext("2d");this.id=_canvas.id;this.hide();this.changeTheme(InfoBlock.BASE_FGCOLOR,InfoBlock.BASE_BGCOLOR)}_canvas.style.top=_t+"px";_canvas.style.left=_l+"px";this.bounds=[_l,_t,_l+_w,_t+_h];this.canvas=_canvas;if(!this.ready){var appendTo=this._inParent?parent.parentNode:document.body;if(this._inParent){appendTo.style.position="relative"}appendTo.appendChild(_canvas);this.ready=true}this.render()};InfoBlock.prototype.render=function(){if(!this.__data)return;var meta=this.__data[0],anim=this.__data[1],duration=this.__data[2]||meta.duration,ratio=this.canvas.__pxRatio;Text._ensureHasBuffer();var _tl=new Text(meta.title||"[No title]","bold "+12*ratio+"px "+InfoBlock.FONT,{color:this.__fgcolor}),_bl=new Text((meta.author||"[Unknown]")+" "+duration+"s"+" "+(anim.width||0)+"x"+(anim.height||0),9*ratio+"px "+InfoBlock.FONT,{color:this.__fgcolor}),_p=InfoBlock.PADDING,_td=_tl.dimen(),_bd=_bl.dimen(),_nw=Math.max(_td[0],_bd[0])+_p+_p,_nh=_td[1]+_bd[1]+_p*3,ctx=this.ctx;canvasOpts(this.canvas,[_nw,_nh],this.canvas.__pxRatio);ctx.save();ctx.clearRect(0,0,_nw,_nh);ctx.fillStyle=this.__bgcolor;Controls.__roundRect(ctx,0,0,_nw,_nh,5);ctx.fill();ctx.fillStyle=this.__fgcolor;ctx.translate(_p,_p);_tl.apply(ctx);ctx.globalAlpha=.8;ctx.translate(0,_bd[1]+_p);_bl.apply(ctx);ctx.restore()};InfoBlock.prototype.inject=function(meta,anim,duration){this.__data=[meta,anim,duration||meta.duration];if(this.ready)this.render()};InfoBlock.prototype.inBounds=function(point){if(this.hidden||!this.bounds)return false;var _b=this.bounds;return point[0]>=_b[0]&&point[0]<=_b[2]&&point[1]>=_b[1]&&point[1]<=_b[3]};InfoBlock.prototype.evtInBounds=function(evt){if(this.hidden)return false;return this.inBounds([evt.pageX,evt.pageY])};InfoBlock.prototype.reset=function(){};InfoBlock.prototype.hide=function(){this.hidden=true;this.canvas.style.display="none"};InfoBlock.prototype.show=function(){this.hidden=false;this.canvas.style.display="block"};InfoBlock.prototype.setDuration=function(value){if(this.__data)this.inject(this.__data[0],this.__data[1],value)};InfoBlock.prototype.changeTheme=function(front,back){this.__fgcolor=front;this.__bgcolor=back};var Strings={};Strings.LOADING="Loading...";Strings.LOADING_ANIMATION="Loading {0}...";var Errors={};Errors.S={};Errors.P={};Errors.A={};Errors.S.NO_JSON_PARSER="JSON parser is not accessible";Errors.S.ERROR_HANDLING_FAILED="Error-handling mechanics were broken with error {0}";Errors.S.NO_METHOD_FOR_PLAYER="No method '{0}' exist for player.";Errors.P.NO_IMPORTER_TO_LOAD_WITH="Cannot load project without importer. Please define it";Errors.P.NO_CANVAS_WITH_ID="No canvas found with given id: {0}";Errors.P.NO_CANVAS_WAS_PASSED="No canvas was passed";Errors.P.CANVAS_NOT_PREPARED="Canvas is not prepared, don't forget to call 'init' method";Errors.P.ALREADY_PLAYING="Player is already in playing mode, please call "+"'stop' or 'pause' before playing again";Errors.P.PAUSING_WHEN_STOPPED="Player is stopped, so it is not allowed to pause";Errors.P.NO_SCENE_PASSED="No scene passed to load method";Errors.P.NO_STATE="There's no player state defined, nowhere to draw, "+"please load something in player before "+"calling its playing-related methods";Errors.P.NO_SCENE="There's nothing at all to manage with, "+"please load something in player before "+"calling its playing-related methods";Errors.P.COULD_NOT_LOAD_WHILE_PLAYING="Could not load any scene while playing or paused, "+"please stop player before loading";Errors.P.BEFOREFRAME_BEFORE_PLAY="Please assign beforeFrame callback before calling play()";Errors.P.AFTERFRAME_BEFORE_PLAY="Please assign afterFrame callback before calling play()";Errors.P.BEFORERENDER_BEFORE_PLAY="Please assign beforeRender callback before calling play()";Errors.P.AFTERRENDER_BEFORE_PLAY="Please assign afterRender callback before calling play()";Errors.P.PASSED_TIME_VALUE_IS_NO_TIME="Given time is not allowed, it is treated as no-time";Errors.P.PASSED_TIME_NOT_IN_RANGE="Passed time ({0}) is not in scene range";Errors.P.DURATION_IS_NOT_KNOWN="Duration is not known";Errors.P.ALREADY_ATTACHED="Player is already attached to this canvas, please use another one";Errors.P.INIT_TWICE="Initialization was called twice";Errors.P.INIT_AFTER_LOAD="Initialization was called after loading a scene";Errors.A.ELEMENT_IS_REGISTERED="This element is already registered in scene";Errors.A.ELEMENT_IS_NOT_REGISTERED="There is no such element registered in scene";Errors.A.UNSAFE_TO_REMOVE="Unsafe to remove, please use iterator-based looping (with returning false from iterating function) to remove safely";
Errors.A.NO_ELEMENT_TO_REMOVE="Please pass some element or use detach() method";Errors.A.NO_ELEMENT="No such element found";Errors.A.ELEMENT_NOT_ATTACHED="Element is not attached to something at all";Errors.A.MODIFIER_NOT_ATTACHED="Modifier wasn't applied to anything";Errors.A.NO_MODIFIER_PASSED="No modifier was passed";Errors.A.NO_PAINTER_PASSED="No painter was passed";Errors.A.MODIFIER_REGISTERED="Modifier was already added to this element";Errors.A.PAINTER_REGISTERED="Painter was already added to this element";var to_export={C:C,M:M,Player:Player,Scene:Scene,Element:Element,Clip:Clip,Path:Path,Text:Text,Sheet:Sheet,Image:_Image,Tweens:Tweens,Tween:Tween,Easing:Easing,Render:Render,Bands:Bands,MSeg:MSeg,LSeg:LSeg,CSeg:CSeg,Errors:Errors,SystemError:SystemError,PlayerError:PlayerError,AnimationError:AnimationError,MODULES:{},obj_clone:obj_clone,createPlayer:function(cvs,opts){var p=new Player;p.init(cvs,opts);return p},ajax:ajax,_typecheck:{builder:__builder,arr:__arr,num:__num,obj:__obj,fun:__fun,str:__str},_valcheck:{finite:__finite,nan:__nan},__dev:{_win:function(){return _window},_winf:function(w){_window=w},strf:_strf,adjust:__adjust,t_cmp:__t_cmp,TIME_PRECISION:TIME_PRECISION}};to_export._$=to_export.createPlayer;to_export.__inject=function(as,to){to[as]=to_export;to.createPlayer=to_export.createPlayer};return to_export}(window);anm.__inject("anm",typeof window!=="undefined"?window:exports);(function(){var C=anm.C;C.MOD_COLLISIONS="collisions";if(anm.M[C.MOD_COLLISIONS])throw new Error("COLLISIONS module already enabled");var opts={pathDriven:false,useSnaps:false,vectorSpan:1,predictSpan:1,mouseBound:false};anm.M[C.MOD_COLLISIONS]=opts;function __filled(arr,val){var l=arr.length;result=new Array(l),i=l;while(i--)result[i]=val;return result}var E=anm.Element;var Path=anm.Path,MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg;var Scene=anm.Scene;E.prototype.bounds=function(t){return this._pradopt(this._cpa_bounds(),t)};E.prototype.dbounds=function(t){var b=this.bounds(t);var minX,minY,maxX,maxY;if(b){minX=b[0];minY=b[1];maxX=b[2];maxY=b[3]}else{minX=minY=Number.MAX_VALUE;maxX=maxY=0}this.travelChildren(function(elm){var cb=elm.bounds(t);if(!cb)return;minX=Math.min(minX,cb[0]);minY=Math.min(minY,cb[1]);maxX=Math.max(maxX,cb[2]);maxY=Math.max(maxY,cb[3])});return[minX,minY,maxX,maxY]};E.prototype.rect=function(t){return this._pradopt(this._cpa_rect(),t)};E.prototype.drect=function(t){var r=this.rect(t);var x1,y1,x2,y2,x3,y3,x4,y4;if(r){x1=r[0];y1=r[1];x2=r[2];y2=r[3];x3=r[4];y3=r[5];x4=r[6];y4=r[7]}else{x1=y1=y2=x4=Number.MAX_VALUE;x2=y4=x3=y3=0}this.travelChildren(function(elm){var cr=elm.rect(t);if(!cr)return;x1=Math.min(x1,cr[0]);y1=Math.min(y1,cr[1]);x2=Math.max(x2,cr[2]);y2=Math.min(y2,cr[3]);x3=Math.max(x3,cr[4]);y3=Math.max(y3,cr[5]);x4=Math.min(x4,cr[6]);y4=Math.max(y4,cr[7])});return[x1,y1,x2,y2,x3,y3,x4,y4]};E.prototype.local=function(pt,t){return this._padopt(pt,t)};E.prototype.global=function(pt,t){return this._pradopt(pt,t)};E.prototype.reactAs=function(path){this.xdata.__cpath=path};E.prototype.reactWith=function(func){this.xdata.__cfunc=func};E.prototype.collectPoints=function(){var x=this.xdata;if(x.__cpath)return x.__cpath.getPoints();if(x.path)return x.path.getPoints();if(x.image||x.text)return this.lrect()};E.prototype.contains=function(pt,t){if(!pt)return false;var b=this._cpa_bounds();if(!b)return false;var pt=this._padopt(pt,t);var x=this.xdata;if(x.__cfunc)return x.__cfunc.call(this,pt);var inBounds;if(inBounds=G.__inBounds(b,pt)){if(!opts.pathDriven)return true;if(x.__cpath)return x.__cpath.contains(pt);if(x.path)return x.path.contains(pt);if(x.image||x.text)return inBounds}return false};E.prototype.dcontains=function(pt,t){var matched=[];if(this.contains(pt,t)){matched.push(this)}if(this.children){elm.visitChildren(function(celm){matched.concat(celm.dcontains(pt,t))})}return matched};E.prototype.intersects=function(elm,t){var rectsMatched;if(rectsMatched=G.__isecRects(this.rect(t),elm.rect(t))){if(!opts.pathDriven)return true;var cx=this.xdata,ex=elm.xdata;var pathOfC=cx.__cpath||cx.path;var pathOfE=ex.__cpath||ex.path;if(!pathOfC&&!pathOfE)return rectsMatched;else if(pathOfC&&pathOfE){return G.__pointsInPath(this.__pathAt(t),elm.__pointsAt(t))||G.__pointsInPath(elm.__pathAt(t),this.__pointsAt(t))}else if(pathOfC&&!pathOfE){var e_rect=elm.rect(t);return G.__pointsInRect(this.__pointsAt(t),e_rect)||G.__pointsInPath(this.__pathAt(t),e_rect)}else if(!pathOfC&&pathOfE){var c_rect=this.rect(t);return G.__pointsInRect(elm.__pointsAt(t),c_rect)||G.__pointsInPath(elm.__pathAt(t),c_rect)}return false}};E.prototype.dintersects=function(elm,t){var matched=[];if(this.intersects(elm,t)){matched.push(this)}if(this.children){elm.visitChildren(function(celm){matched.concat(celm.dintersects(elm,t))})}return matched};E.prototype.collides=function(elm,func){if(!this._collisionTests)this._collisionTests=[];if(!this._collisionElms)this._collisionElms=[];this._collisionTests.push(func);this._collisionElms.push(elm)};E.prototype.dcollides=function(elm,t){throw new Error("Not implemented")};E.prototype._adopt=function(pts,t){if(!pts)return null;this.__ensureTimeTestAllowedFor(t);var s=t==null?this.state:this.stateAt(t);if(!s._applied)return __filled(pts,Number.MIN_VALUE);return this.__adoptWithM(pts,E._getIMatrixOf(s))};E.prototype._radopt=function(pts,t){if(!pts)return null;this.__ensureTimeTestAllowedFor(t);var s=t==null?this.state:this.stateAt(t);if(!s._applied)return __filled(pts,Number.MIN_VALUE);return this.__adoptWithM(pts,E._getMatrixOf(s))};E.prototype._padopt=function(pt,t){var p=this.parent;while(p){pt=p._adopt(pt,t);p=p.parent}return this._adopt(pt,t)};E.prototype._pradopt=function(pt,t){var pt=this._radopt(pt,t);var p=this.parent;while(p){pt=p._radopt(pt,t);p=p.parent}return pt};E.prototype.__adoptWithM=function(pts,m){if(pts.length>2){var transformed=[];for(var pi=0,pl=pts.length;pi<pl;pi+=2){var tpt=m.transformPoint(pts[pi],pts[pi+1]);transformed.push(tpt[0],tpt[1])}return transformed}else{return m.transformPoint(pts[0],pts[1])}};E.___vecErrText="Ensure you have passed actual "+"(current) time to _getVects "+"or check if vectorSpan value is > (1 / min.framerate) "+"or may be framerate itself is too low";E.prototype._makeGhost=function(t){var s0,s1,t_diff;var t_pred=opts.predictSpan;if(!opts.useSnaps){if(this.__modifying!==null){s0=this.state;s1=this._state}else{s0=this.state._||this.state;s1=this.state}t_diff=t-s0._appliedAt}else{var s=this.__modifying!==null?this._state:this.state,sn0=s.snap0,sn1=s.snap1;if(!sn0&&!sn1)throw new Error("No vector data available, is this element tracked?");var pos=Math.floor(t/opts.vectorSpan);if(!sn1){if(pos!=sn0._at)throw new Error(E.__vecErrText);s0=sn0;s1=s;t_diff=t-sn0._atT}else{var pass_t=t-sn1._atT;if(pass_t<=opts.vectorSpan){var span_t=sn1._atT-sn0._atT;if(span_t<opts.vectorSpan-pass_t)throw new Error(E.__vecErrText);var span_pos=span_t-(opts.vectorSpan-pass_t);s0=E._stateBetween(sn0,sn1,span_t,span_pos);s1=s;t_diff=opts.vectorSpan}else{s0=sn1;s1=s;t_diff=pass_t}}}var vec=E._getVect(s0,s1||s0,t_diff);var ghost=E._predictState(s1||s0,vec,opts.predictSpan);ghost._applied=true;ghost._appliedAt=t;ghost._matrix=E._getMatrixOf(ghost,ghost._matrix);ghost._vec=vec;ghost._tdiff=t_diff;this.__ghost=ghost;return ghost};E.prototype._defCollides=function(t,elm,func){var prev_src_st=this.state;var prev_cmp_st=elm.state;var src_ghost=this._makeGhost(t);var cmp_ghost=elm._makeGhost(t);this.state=src_ghost;elm.state=cmp_ghost;var intersects=this.intersects(elm);this.state=prev_src_st;elm.state=prev_cmp_st;if(intersects){func.call(this,t,src_ghost._tdiff,src_ghost._vec,cmp_ghost._vec)}};E.prototype.__pathAt=function(t){var path=this.xdata.__cpath||this.xdata.path;if(!path)throw new Error("No path found for elm "+this.id);var mpath=path.duplicate();var me=this;mpath.vpoints(function(x,y){return me._pradopt([x,y],t)});return mpath};E.prototype.__pointsAt=function(t){return this._pradopt(this.collectPoints(),t)};E.prototype._cpa_bounds=function(){var cpath=this.xdata.__cpath;return cpath?cpath.bounds():this.lbounds()};E.prototype._cpa_rect=function(){var cpath=this.xdata.__cpath;return cpath?cpath.rect():this.lrect()};E.prototype.__ensureTimeTestAllowedFor=function(t){if(t!=null&&this.__modifying!=null&&this.__modifying!==E.EVENT_MOD){throw new Error("Time-related tests may happen only outside of modifier or inside event handler")}return true};E._getVect=function(s0,s1,t_diff){if(t_diff==0)return E.createState();return{x:(s1.x-s0.x)/t_diff,y:(s1.y-s0.y)/t_diff,lx:(s1.lx-s0.lx)/t_diff,ly:(s1.ly-s0.ly)/t_diff,rx:(s1.rx-s0.rx)/t_diff,ry:(s1.ry-s0.ry)/t_diff,sx:(s1.sx-s0.sx)/t_diff,sy:(s1.sy-s0.sy)/t_diff,angle:(s1.angle-s0.angle)/t_diff,alpha:(s1.alpha-s0.alpha)/t_diff}};E._stateBetween=function(s0,s1,t_diff,at){if(t_diff==0)return s0;return{x:s0.x+(s1.x-s0.x)/t_diff*at,y:s0.y+(s1.y-s0.y)/t_diff*at,lx:s0.lx+(s1.lx-s0.lx)/t_diff*at,ly:s0.lx+(s1.ly-s0.ly)/t_diff*at,rx:s0.rx+(s1.rx-s0.rx)/t_diff*at,ry:s0.ry+(s1.ry-s0.ry)/t_diff*at,sx:s0.sx+(s1.sx-s0.sx)/t_diff*at,sy:s0.sy+(s1.sy-s0.sy)/t_diff*at,angle:s0.angle+(s1.angle-s0.angle)/t_diff*at,alpha:s0.alpha+(s1.alpha-s0.alpha)/t_diff*at}};E._predictState=function(s1,vec,t_pred){return{x:s1.x+vec.x*t_pred,y:s1.y+vec.y*t_pred,lx:s1.lx+vec.lx*t_pred,ly:s1.ly+vec.ly*t_pred,rx:s1.rx+vec.rx*t_pred,ry:s1.ry+vec.ry*t_pred,sx:s1.sx+vec.sx*t_pred,sy:s1.sy+vec.sy*t_pred,angle:s1.angle+vec.angle*t_pred,alpha:s1.alpha+vec.alpha*t_pred}};function p_drawCPath(ctx,cPath){if(!(cPath=cPath||this.__cpath))return;cPath.cstroke("#f00",2);cPath.apply(ctx)}function p_drawAdoptedRect(ctx){var rect=this.$._cpa_rect();if(rect){var ratio=ctx.canvas.__pxRatio||1;rect=this.$._pradopt(rect);ctx.save();ctx.setTransform(ratio,0,0,ratio,0,0);ctx.fillStyle="#0f0";ctx.fillRect(rect[0]-2,rect[1]-2,4,4);ctx.fillRect(rect[2]-2,rect[3]-2,4,4);ctx.fillRect(rect[4]-2,rect[5]-2,4,4);ctx.fillRect(rect[6]-2,rect[7]-2,4,4);ctx.beginPath();ctx.strokeStyle="#0f0";ctx.lineWidth=2;ctx.moveTo(rect[0],rect[1]);ctx.lineTo(rect[2],rect[3]);ctx.lineTo(rect[4],rect[5]);ctx.lineTo(rect[6],rect[7]);ctx.lineTo(rect[0],rect[1]);ctx.closePath();ctx.stroke();ctx.restore()}}function p_drawAdoptedPoints(ctx){var pts=this.$.collectPoints();if(pts){var ratio=ctx.canvas.__pxRatio||1;pts=this.$._pradopt(pts);ctx.save();ctx.setTransform(ratio,0,0,ratio,0,0);ctx.fillStyle="#00f";for(var pi=0,pl=pts.length;pi<pl;pi+=2){ctx.fillRect(pts[pi]-2,pts[pi+1]-2,4,4)}ctx.restore()}}function p_drawGhost(ctx){var me=this.$;if(me.__ghost&&!me.__ghostLock){var ratio=ctx.canvas.__pxRatio||1;ctx.save();me.__ghostLock=true;ctx.setTransform(ratio,0,0,ratio,0,0);me.__ghost._matrix.apply(ctx);ctx.globalAlpha=.6;me.draw(ctx);me.__ghostLock=false;ctx.restore()}}var prevAddDebugRender=E.__addDebugRender;E.__addDebugRender=function(elm){prevAddDebugRender(elm);elm.__paint({type:E.DEBUG_PNT},p_drawCPath);elm.__paint({type:E.DEBUG_PNT},p_drawAdoptedRect);elm.__paint({type:E.DEBUG_PNT},p_drawAdoptedPoints);elm.__paint({type:E.DEBUG_PNT},p_drawGhost)};var prevMAfter=E.prototype.__mafter;E.prototype.__mafter=function(t,type,result){prevMAfter.call(this,t,type,result);if(result&&type===E.LAST_MOD){if(opts.useSnaps&&this.track){this.__updateSnaps(t)}var colTests=this._collisionTests;if(colTests&&colTests.length>0){var colElms=this._collisionElms;for(var ci=0,cl=colTests.length;ci<cl;ci++){this._defCollides(t,colElms[ci],colTests[ci])}this._collisionTests=[];this._collisionElms=[]}}};E.prototype.__updateSnaps=function(t){var pos=Math.floor(t/opts.vectorSpan);var s=this.state,_s=this._state;if(!s._applied||!s.snap0){_s.snap0=anm.obj_clone(_s);_s.snap0._at=pos;_s.snap0._atT=t;_s.snap1=null}else if(s.snap0){var offset0=pos-s.snap0._at;if(!s.snap1&&pos>0){_s.snap1=anm.obj_clone(_s);_s.snap1._at=pos;_s.snap1._atT=t}else if(offset0>1&&pos!=s.snap1._at){_s.snap0=s.snap1;_s.snap1=anm.obj_clone(_s);_s.snap1._at=pos;_s.snap1._atT=pos}else{_s.snap0=s.snap0;_s.snap1=s.snap1}if(_s.snap1&&t-_s.snap1._at<0){_s.snap0=null;_s.snap1=null}}};E.prototype._getVects=function(t){var s=this._state,s0=s.snap0,s1=s.snap1;if(!s0&&!s1)throw new Error("No vector data available, is this element tracked?");var pos=Math.floor(t/opts.vectorSpan);if(!s1){if(pos!=s0._at)throw new Error(E.__vecErrText);var vec_t=t-s0._at;return{mov:[s0.x,s0.y,s.x,s.y,vec_t],rot:[s0.angle,s.angle,vec_t],scl:[s0.sx,s0.sy,s.sx,s.sy,vec_t]}}else{var pass_t=t-s1._at;if(pass_t>opts.vectorSpan){return{mov:[s1.x,s1.y,s.x,s.y,pass_t],rot:[s1.angle,s.angle,pass_t],scl:[s1.sx,s1.sy,s.x,s.y,pass_t]}}var span_t=s1._at-s0._at;if(span_t<opts.vectorSpan-pass_t)throw new Error(E.__vecErrText);var span_pos=span_t-(opts.vectorSpan-pass_t);var vec_t=opts.vectorSpan;return{mov:[s0.x+(s1.x-s0.x)*span_pos,s0.y+(s1.y-s0.y)*span_pos,s1.x+(s.x-s1.x)*pass_t,s1.y+(s.y-s1.y)*pass_t,vec_t],rot:[s0.angle+(s1.angle-s0.angle)*span_pos,s1.angle+(s.x-s1.x)*pass_t,s1.y+(s.y-s1.y)*pass_t,vec_t],scl:[s0.sx+(s1.sx-s0.sx)*span_pos,s0.sy+(s1.sy-s0.sy)*span_pos,s1.sx+(s.sx-s1.sx)*pass_t,s1.sy+(s.sy-s1.sy)*pass_t,vec_t]}}throw new Error(E.__vecErrText)};var prev_handle__x=Scene.prototype.handle__x;Scene.prototype.handle__x=function(type,evt){if(opts.mouseBound){if(type&C.XT_MOUSE){switch(type){case C.X_MCLICK:case C.X_MDCLICK:case C.X_MUP:case C.X_MDOWN:{this.visitElems(function(elm){if(elm.visible&&elm.contains(evt.pos))elm.fire(type,evt)});return true}case C.X_MMOVE:{this.visitElems(function(elm){if(elm.visible){if(elm.contains(evt.pos)){elm.fire(C.X_MMOVE,evt);if(elm.__wout){elm.fire(C.X_MOVER,evt);elm.__wout=false}}else{if(!elm.__wout){elm.fire(C.X_MOUT,evt);elm.__wout=true}}}});return true}case C.X_MOVER:case C.X_MOUT:{return true}}}}prev_handle__x.call(this,type,evt)};Path.prototype.contains=function(pt){return(this.crosses(pt)&-1)!=0};Path.prototype.crosses=function(pt){if(this.segs.length<2)return false;var start=this.start();var cur=start;var crossings=0;this.visit(function(segment){crossings+=segment.crosses(cur,pt);cur=segment.last()});if(pt[0]!=start[0]&&pt[1]!=start[1]){crossings+=G.__lineCrosses(pt[0],pt[1],cur[0],cur[1],start[0],start[1])}return crossings};MSeg.prototype.crosses=function(start,point){var pts=this.pts;return G.__lineCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1])};LSeg.prototype.crosses=function(start,point){var pts=this.pts;return G.__lineCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1])};CSeg.prototype.crosses=function(start,point){var level=level||0,pts=this.pts;return G.__curveCrosses(point[0],point[1],start[0],start[1],pts[0],pts[1],pts[2],pts[3],pts[4],pts[5],0)};var G={};G.__zeroBounds=function(b){return b[0]===b[1]&&b[1]===b[2]&&b[2]===b[3]};G.__zeroRect=function(r){return r[0]===r[1]&&r[1]===r[2]&&r[2]===r[3]&&r[3]===r[4]&&r[4]===r[5]&&r[5]===r[6]&&r[6]===r[7]};G.__inBounds=function(b,pt,zeroTest){if(!b)throw new Error("Bounds are not accessible");if(zeroTest&&G.__zeroBounds(b))return false;return pt[0]>=b[0]&&pt[0]<=b[2]&&pt[1]>=b[1]&&pt[1]<=b[3]};G.__inRect=function(r,pt,zeroTest){if(!r)throw new Error("Rect is not accessible");if(zeroTest&&G.__zeroRect(r))return false;return pt[0]>=r[0]&&pt[0]<=r[2]&&pt[1]>=r[1]&&pt[1]<=r[5]};G.__edgeTest=function(p1,p2,p3,r2){var rot=[-(p2[1]-p1[1]),p2[0]-p1[0]];var ref=rot[0]*(p3[0]-p1[0])+rot[1]*(p3[1]-p1[1])>=0;for(var i=0,il=r2.length;i<il;i+=2){if(rot[0]*(r2[i]-p1[0])+rot[1]*(r2[i+1]-p1[1])>=0===ref)return false}return true};G.__isecRects=function(r1,r2){if(!r1||!r2)throw new Error("One (or both) of rects / bounds is not accessible");if(G.__zeroRect(r1)||G.__zeroRect(r2))return false;var edgeTest=G.__edgeTest;var pn,px;for(var pi=0,pl=r1.length;pi<pl;pi+=2){pn=pi===pl-2?0:pi+2;px=pn===pl-2?0:pn+2;if(edgeTest([r1[pi],r1[pi+1]],[r1[pn],r1[pn+1]],[r1[px],r1[px+1]],r2))return false}for(var pi=0,pl=r2.length;pi<pl;pi+=2){pn=pi===pl-2?0:pi+2;px=pn===pl-2?0:pn+2;if(edgeTest([r2[pi],r2[pi+1]],[r2[pn],r2[pn+1]],[r2[px],r2[px+1]],r1))return false}return true};G.__pointsInPath=function(path,pts){for(var pi=0,pl=pts.length;pi<pl;pi+=2){if(path.contains([pts[pi],pts[pi+1]]))return true}return false};G.__pointsInRect=function(r,pts){if(G.__zeroRect(r))return false;var inRect=G.__inRect;for(var pi=0,pl=pts.length;pi<pl;pi+=2){if(inRect(r,[pts[pi],pts[pi+1]],false))return true}return false};G.__lineCrosses=function(px,py,x0,y0,x1,y1){if(py<y0&&py<y1)return 0;if(py>=y0&&py>=y1)return 0;if(px>=x0&&px>=x1)return 0;if(px<x0&&px<x1)return y0<y1?1:-1;var xitcpt=x0+(py-y0)*(x1-x0)/(y1-y0);if(px>=xitcpt)return 0;return y0<y1?1:-1};G.__curveCrosses=function(px,py,x0,y0,xc0,yc0,xc1,yc1,x1,y1,level){var level=level||0;if(py<y0&&py<yc0&&py<yc1&&py<y1)return 0;if(py>=y0&&py>=yc0&&py>=yc1&&py>=y1)return 0;if(px>=x0&&px>=xc0&&px>=xc1&&px>=x1)return 0;if(px<x0&&px<xc0&&px<xc1&&px<x1){if(py>=y0){if(py<y1)return 1}else{if(py>=y1)return-1}return 0}if(level>52)return G.__lineCrosses(px,py,x0,y0,x1,y1);var xmid=(xc0+xc1)/2,ymid=(yc0+yc1)/2;var xc0=(x0+xc0)/2,yc0=(y0+yc0)/2,xc1=(xc1+x1)/2,yc1=(yc1+y1)/2;var xc0m=(xc0+xmid)/2,yc0m=(yc0+ymid)/2;xmc1=(xmid+xc1)/2;ymc1=(ymid+yc1)/2;xmid=(xc0m+xmc1)/2;ymid=(yc0m+ymc1)/2;if(isNaN(xmid)||isNaN(ymid)){return 0}return G.__curveCrosses(px,py,x0,y0,xc0,yc0,xc0m,yc0m,xmid,ymid,level+1)+G.__curveCrosses(px,py,xmid,ymid,xmc1,ymc1,xc1,yc1,x1,y1,level+1)}})();window.Builder=function(){var Path=anm.Path;var Element=anm.Element;var Text=anm.Text;var Image=anm.Image;var Sheet=anm.Sheet;var C=anm.C;var MSeg=anm.MSeg,LSeg=anm.LSeg,CSeg=anm.CSeg;var is=anm._typecheck;var modCollisions=C.MOD_COLLISIONS;var __b_cache={};function Builder(obj){if(!obj){this.n="";this.v=new Element;this.x=this.v.xdata}else if(obj instanceof Builder){this.n=obj.n;this.v=obj.v.deepClone();this.x=this.v.xdata;this.f=this._extractFill(obj.f);this.s=this._extractStroke(obj.s);this.v.__b$=this;return}else if(obj instanceof Element){this.n=obj.name;this.v=obj;this.x=obj.xdata}else if(is.str(obj)){this.n=obj;this.v=new Element;this.v.name=this.n;this.x=this.v.xdata}this.v.__b$=this;this.f=this._extractFill(Builder.DEFAULT_FILL);this.s=this._extractStroke(Builder.DEFAULT_STROKE);this.d=undefined;this.a=undefined}Builder._$=function(obj){if(obj&&obj instanceof Element){if(__b_cache[obj.id])return __b_cache[obj.id];return __b_cache[obj.id]=new Builder(obj)}var inst=new Builder(obj);__b_cache[inst.v.id]=inst;return inst};Builder.__path=function(val,join){return is.arr(val)?Builder.path(val):val instanceof Path?val:Path.parse(val,join)};Builder.DEFAULT_STROKE=Path.EMPTY_STROKE;Builder.DEFAULT_FILL=Path.BASE_FILL;Builder.DEFAULT_CAP=Path.DEFAULT_CAP;Builder.DEFAULT_JOIN=Path.DEFAULT_JOIN;Builder.DEFAULT_FFACE=Text.DEFAULT_FFACE;Builder.DEFAULT_FSIZE=Text.DEFAULT_FSIZE;Builder.prototype.add=function(what){if(what instanceof Element){this.v.add(what)}else if(what instanceof Builder){this.v.add(what.v)}return this};Builder.prototype.remove=function(what){if(what instanceof Element){this.v.remove(what)}else if(what instanceof Builder){this.v.remove(what.v)}else throw new Error("Don't know what to remove");return this};Builder.prototype.path=function(path,pt){var path=Builder.__path(path,this.x.path);this.x.path=path;path.normalize();this.x.reg=[0,0];this.x.pos=pt||[0,0];if(!path.fill){path.fill=this.f}else{this.f=path.fill}if(!path.stroke){path.stroke=this.s}else{this.s=path.stroke}return this};Builder.prototype.rect=function(pt,rect){var rect=is.arr(rect)?rect:[rect,rect];var w=rect[0],h=rect[1];this.path([[0,0],[w,0],[w,h],[0,h],[0,0]],pt);return this};Builder.prototype.circle=function(pt,radius){this.x.pos=pt;this.x.reg=[0,0];this.x.__bounds=[-radius,-radius,radius,radius];this.paint(function(ctx){var b=this.$.__b$;Path.applyF(ctx,b.f,b.s,function(){ctx.arc(0,0,radius,0,Math.PI*2,true)})});if(modCollisions)this.v.reactAs(Builder.arcPath(0,0,radius,0,1,12));return this};Builder.prototype.image=function(pt,src,callback){this.x.pos=pt;if(src){var b=this;this.x.sheet=new Image(src,callback)}return this};Builder.prototype.text=function(pt,lines,size,font){this.x.pos=pt;var text=lines instanceof Text?lines:new Text(lines,Builder.font(font,size));this.x.text=text;this.x.reg=[0,0];if(!text.stroke){text.stroke=this.s}else{this.s=text.stroke}if(!text.fill){text.fill=this.f}else{this.f=text.fill}return this};Builder.prototype.sprite=function(pt,src,tile_spec,callback){this.x.pos=pt;var animator;if(is.str(src)){animator=Builder.sheet(src,tile_spec,callback)(this.v)}else if(is.fun(src)){animator=src(this.v)}else throw new Error("Incorrect source for sprite");this.x.sheet=animator.sheet;this.a=animator;return this};Builder.prototype.switch=function(frames,fps,repeat){if(!this.a)throw new Error("This builder has no animator, so no switch possible");this.a.switch(frames,fps,repeat);return this};Builder.prototype.animate=function(t,frames,fps,repeat){if(!this.a)throw new Error("This builder has no animator, so no animation possible");this.a.animate(t,frames,fps,repeat);return this};Builder.prototype.run=function(t){if(!this.a)throw new Error("This builder has no animator, so no running possible");this.a.run(t);return this};Builder.prototype.fill=function(fval){this.f=is.str(fval)?{color:fval}:fval.r?{rgrad:fval}:{lgrad:fval};if(this.x.path)this.x.path.fill=this.f;if(this.x.text)this.x.text.fill=this.f;return this};Builder.prototype.stroke=function(sval,width,cap,join){this.s=is.str(sval)?{width:width!=null?width:Builder.DEFAULT_STROKE.width,color:sval,cap:cap||Builder.DEFAULT_CAP,join:join||Builder.DEFAULT_JOIN}:sval.r?{rgrad:sval}:{lgrad:sval};if(this.x.path)this.x.path.stroke=this.s;if(this.x.text)this.x.text.stroke=this.s;return this};Builder.prototype.nofill=function(){this.f=null;if(this.x.path)this.x.path.fill=null;if(this.x.text)this.x.text.fill=null;return this};Builder.prototype.nostroke=function(){this.s=null;if(this.x.path)this.x.path.stroke=null;if(this.x.text)this.x.text.stroke=null;return this};Builder.prototype.reg=function(pt){var x=this.x;x.reg=pt;return this};C.R_TL=1;C.R_TC=5;C.R_TR=2;C.R_ML=6;C.R_MC=0;C.R_MR=7;C.R_BL=3;C.R_BC=8;C.R_BR=4;Builder.prototype.regAt=function(side){var x=this.x,_new=x.reg;var b=this.v.lbounds();if(!b)return this;var w=b[2]-b[0],h=b[3]-b[1];switch(side){case C.R_TL:_new=[-w/2,-h/2];break;case C.R_TC:_new=[0,-h/2];break;case C.R_TR:_new=[w/2,-h/2];break;case C.R_ML:_new=[-w/2,0];break;case C.R_MC:_new=[0,0];break;case C.R_MR:_new=[w/2,0];break;case C.R_BL:_new=[-w/2,h/2];break;case C.R_BC:_new=[0,h/2];break;case C.R_BR:_new=[w/2,h/2];break}x.reg=_new;return this};Builder.prototype.move=function(pt){var x=this.x;x.pos=[x.pos[0]+pt[0],x.pos[1]+pt[1]];return this};Builder.prototype.pos=function(pt){if(pt){this.x.pos=[pt[0],pt[1]];return this}else return this.x.pos};Builder.prototype.zoom=function(val){if(this.x.path){this.x.path.zoom(val);this.path(this.x.path)}return this};Builder.prototype.bounds=function(bounds){if(!bounds.length===4)throw new Error("Incorrect bounds");this.x.__bounds=bounds;return this};Builder.prototype.band=function(band){this.v.setBand(band);return this};Builder.prototype.duration=function(value){if(this.v.parent)throw new Error("Please set duration only to the root element");this.d=value;return this};Builder.prototype.tween=function(type,band,data,easing){this.v.addTween({type:type,time:band,data:data,easing:easing});return this};Builder.prototype.rtween=function(type,band,data,easing){this.v.addTween({type:type,time:band,data:data,easing:easing,relative:true});return this};Builder.prototype.untween=Builder.prototype.unmodify;Builder.prototype.rotate=function(band,angles,easing){return this.tween(C.T_ROTATE,band,angles,easing)};Builder.prototype.rotateP=function(band,easing){return this.tween(C.T_ROT_TO_PATH,band,null,easing)};Builder.prototype.scale=function(band,values,easing){return this.tween(C.T_SCALE,band,values,easing)};Builder.prototype.xscale=function(band,values,easing){return this.scale(band,[[values[0],values[0]],[values[1],values[1]]],easing)};Builder.prototype.trans=function(band,points,easing){return this.transP(band,[[points[0][0],points[0][1]],[points[1][0],points[1][1]]],easing)};Builder.prototype.transP=function(band,path,easing){return this.tween(C.T_TRANSLATE,band,Builder.__path(path,this.x.path),easing)};Builder.prototype.alpha=function(band,values,easing){return this.tween(C.T_ALPHA,band,values,easing)};Builder.prototype.mode=function(mode,nrep){this.x.mode=mode;if(typeof nrep!=="undefined")this.x.nrep=nrep;return this};Builder.prototype.once=function(){return this.mode(C.R_ONCE)};Builder.prototype.stay=function(){return this.mode(C.R_STAY)};Builder.prototype.loop=function(val){return this.mode(C.R_LOOP,val)};Builder.prototype.repeat=function(val){return this.mode(C.R_LOOP,val)};Builder.prototype.bounce=function(val){return this.mode(C.R_BOUNCE,val)};Builder.prototype.modify=function(band,modifier,data,easing,priority){if(is.arr(band)||is.num(band)){this.v.addModifier({time:band,easing:easing,data:data,priority:priority},modifier)}else{priority=easing;easing=data;data=modifier;modifier=band;this.v.addModifier({easing:easing,data:data,priority:priority},modifier)}return this};Builder.prototype.rmodify=function(band,modifier,data,easing,priority){if(is.arr(band)||is.num(band)){this.v.addModifier({time:band,easing:easing,data:data,relative:true,priority:priority},modifier)}else{priority=easing;easing=data;data=modifier;modifier=band;this.v.addModifier({easing:easing,data:data,relative:true,priority:priority},modifier)}return this};Builder.prototype.paint=function(func,data,priority){this.v.addPainter(func,data,priority);return this};Builder.prototype.at=function(t,func,data,priority){return this.modify(t,func,data,priority)};Builder.prototype.rat=function(t,func,data,priority){return this.rmodify(t,func,data,priority)};Builder.prototype.unmodify=function(modifier){this.v.removeModifier(modifier);return this};Builder.prototype.unpaint=function(painter){this.v.removePainter(painter);return this};Builder.prototype.key=function(name,value){this.x.keys[name]=value;return this};Builder.prototype.time=function(f){this.x.tf=f;return this};Builder.prototype.tease=function(ease){if(!ease)throw new Error("Ease function not defined");var duration=this.x.duration();this.time(function(t){return ease(t/duration)});return this};Builder.prototype.on=function(type,handler){this.v.m_on(type,handler);return this};Builder.prototype.unhandle=Builder.prototype.unmodify;Builder.prototype.take=function(b){this.n=obj.n;this.v=obj.v.clone();this.x=this.v.xdata};Builder.prototype.use=function(b){this.n=obj.n;this.v=obj.v.deepClone();this.x=this.v.xdata};Builder.prototype.disable=function(){this.v.disabled=true;this.v.travelChildren(function(elm){elm.disabled=true});return this};Builder.prototype.enable=function(){this.v.disabled=false;this.v.travelChildren(function(elm){elm.disabled=false});return this};Builder.prototype.each=function(func){this.v.visitChildren(func);return this};Builder.prototype.deach=function(func){this.v.travelChildren(func);return this};Builder.prototype.iter=function(func,rfunc){this.v.iterateChildren(func,rfunc);return this};Builder.prototype.diter=function(func,rfunc){this.v.deepIterateChildren(func,rfunc);return this};Builder.prototype.detach=function(){this.v.detach();return this};Builder.prototype.clear=function(){this.v.clear();return this};Builder.prototype.data=function(value){if(typeof value!=="undefined"){this.v.data(value);return this}return this.v.data()};Builder.prototype.acomp=function(value){this.x.acomp=value;return this};Builder.prototype.mask=function(mask){if(mask instanceof Element){this.v.setMask(mask)}else if(mask instanceof Builder){this.v.setMask(mask.v)}return this};Builder.prototype._extractStroke=function(def_){if(this.x.path)return this.x.path.stroke||def_;if(this.x.text)return this.x.text.stroke||def_;return def_};Builder.prototype._extractFill=function(def_){if(this.x.path)return this.x.path.fill||def_;if(this.x.text)return this.x.text.fill||def_;return def_};Builder.rgb=function(r,g,b,a){return"rgba("+Math.floor(r)+","+Math.floor(g)+","+Math.floor(b)+","+(typeof a!=="undefined"?a:1)+")"};Builder.frgb=function(r,g,b,a){return B.rgb(r*255,g*255,b*255,a)};Builder.hsv=function(h,s,v,a){return B.fhsv(h/360,s,v,a)};Builder.fhsv=function(h,s,v,a){var c=v*s;var h1=h*6;var x=c*(1-Math.abs(h1%2-1));var m=v-c;var rgb;if(h1<1)rgb=[c,x,0];else if(h1<2)rgb=[x,c,0];else if(h1<3)rgb=[0,c,x];else if(h1<4)rgb=[0,x,c];else if(h1<5)rgb=[x,0,c];else if(h1<=6)rgb=[c,0,x];return Builder.rgb(255*(rgb[0]+m),255*(rgb[1]+m),255*(rgb[2]+m),a)};Builder.lgrad=function(dir,stops){return{dir:dir,stops:stops}};Builder.rgrad=function(dir,rad,stops){return{dir:dir,r:rad,stops:stops}};Builder.path=function(points){var p=new Path;p.add(new MSeg([points[0][0],points[0][1]]));var i=1,pl=points.length;for(;i<pl;i++){var pts=points[i];if(pts.length<3){p.add(new LSeg([pts[0],pts[1]]))}else{p.add(new CSeg([pts[0],pts[1],pts[2],pts[3],pts[4],pts[5]]))}}return p};Builder.easing=function(func,data){return{f:function(data){return func},data:data}};Builder.easingF=Builder.easing;Builder.easingP=function(path){return{type:C.E_PATH,data:Builder.__path(path)}};Builder.easingC=function(seg){return{type:C.E_CSEG,data:seg instanceof CSeg?seg:new CSeg(seg)}};Builder.tween=function(){};Builder.font=function(name,size){var fface=name||Builder.DEFAULT_FFACE;fface=is.str(fface)?fface:fface.join(",");var fsize=size!=null?size:Builder.DEFAULT_FSIZE;return fsize+"px "+fface};var __t=anm.__dev.adjust;if(!__t)throw new Error("adjust should be defined");function _get_frame(start,t,anim){var frames=anim[0],fps=anim[1],step=frames.length>2?frames[2]:1,repeat=frames.length>3?frames[3]:false,start_frame=frames[0],end_frame=frames[1],dt=__t(t-start);var len=__t(end_frame+1-start_frame);var tframe=Math.floor(dt*fps)*step;if(tframe<0)return-1;if(!repeat&&tframe>=len)return-1;if(repeat){tframe=tframe%len}return Math.floor(start_frame+tframe)}function _Animator(sheet,elm){this.sheet=sheet;this.elm=elm;this.cur_anim=null;var me=this;this.elm.addModifier(function(t){if(!me.cur_anim)return false;var frame=_get_frame(me.start,t,me.cur_anim);if(frame>=0){sheet.cur_region=frame}else{sheet.cur_region=-1;me.cur_anim=null;return false}})}_Animator.prototype.switch=function(frames,fps,repeat){this._prepared_anim=[frames,fps,repeat]};_Animator.prototype.run=function(t){this.start=t;this.cur_anim=this._prepared_anim};_Animator.prototype.animate=function(t,frames,fps,repeat){this.switch(frames,fps,repeat);this.run(t)};Builder.sheet=function(src,tile_spec,callback){var sheet=new Sheet(src,function(img,sheet){if(is.arr(tile_spec)){var tdimen=tile_spec,sdimen=sheet.dimen,h_factor=Math.floor(sdimen[0]/tdimen[0]);sheet.region_f=function(n){var v_pos=Math.floor(n/h_factor),h_pos=n%h_factor;return[h_pos*tdimen[0],v_pos*tdimen[1],tdimen[0],tdimen[1]]}}else if(is.fun(tile_spec)){sheet.region_f=tile_spec}if(callback)callback()});return function(elm){return new _Animator(sheet,elm)}};Builder.arcPath=function(centerX,centerY,radius,startAngle,arcAngle,steps){var twoPI=2*Math.PI;var angleStep=arcAngle/steps;var res=[];var xx=centerX+Math.cos(startAngle*twoPI)*radius;var yy=centerY+Math.sin(startAngle*twoPI)*radius;res.push([xx,yy]);for(var i=1;i<=steps;i++){var angle=startAngle+i*angleStep;xx=centerX+Math.cos(angle*twoPI)*radius;yy=centerY+Math.sin(angle*twoPI)*radius;res.push([xx,yy])}return Builder.path(res)};var prevClone=Element.prototype.clone;Element.prototype.clone=function(){var clone=prevClone.call(this);clone.__b$=this.__b$;return clone};return Builder}();